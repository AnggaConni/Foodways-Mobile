<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ff1b2d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Foodways Mobile</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- HTML2PDF & HTML2CANVAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --opera-red: #ff1b2d;
            --opera-dark: #121212;
            --opera-gray: #f9f9f9;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            background-color: var(--opera-gray); 
            color: #1a1a1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; 
            height: 100vh;
            height: 100dvh; 
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }

        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mobile Card Styles */
        .mobile-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 12px;
            border: 1px solid #f0f0f0;
            transition: transform 0.1s;
        }
        .mobile-card:active { transform: scale(0.98); }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #eee;
            padding-bottom: var(--safe-bottom);
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: calc(60px + var(--safe-bottom));
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 10px;
            font-weight: 500;
            width: 100%;
            height: 100%;
        }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: var(--opera-red); }

        /* Full Screen Views */
        .view-container {
            height: 100%;
            width: 100%;
            overflow-y: auto;
            padding-bottom: calc(70px + var(--safe-bottom)); /* Space for bottom nav */
            background: var(--opera-gray);
        }

        /* Leaflet Tweaks */
        .leaflet-container { background: #e0e0e0; font-family: inherit; }
        .custom-tooltip {
            background: white !important; 
            border: 2px solid var(--opera-red) !important;
            color: black !important;
            border-radius: 4px !important;
            font-weight: bold !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
        }

        /* Modal Transitions (Slide Up) */
        .modal-enter { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-active { transform: translateY(0); }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 6px;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>

    <!-- 1. LANDING PAGE (Splash Screen) -->
    <div id="landing-page" class="fixed inset-0 z-[5000] bg-white flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500">
        <div class="mb-6 relative">
            <div class="absolute inset-0 bg-red-100 rounded-full animate-ping opacity-75"></div>
            <div class="w-24 h-24 bg-white border-4 border-red-50 rounded-full flex items-center justify-center relative z-10 shadow-lg">
                <i class="fas fa-pepper-hot text-4xl text-[var(--opera-red)]"></i>
            </div>
        </div>
        <h1 class="text-3xl font-black text-gray-900 mb-2">Foodways</h1>
        <p class="text-sm text-gray-500 uppercase tracking-widest mb-8">Shared Heritage</p>
        
        <div id="loading-indicator" class="flex flex-col items-center">
            <i class="fas fa-circle-notch fa-spin text-red-500 text-2xl mb-3"></i>
            <span class="text-xs text-gray-400 font-mono">Syncing Database...</span>
        </div>

        <button id="btn-enter" onclick="app.enterApp()" class="hidden w-full max-w-xs bg-[var(--opera-red)] text-white font-bold py-4 rounded-full shadow-xl active:scale-95 transition-transform flex items-center justify-center gap-2">
            Start Exploring <i class="fas fa-arrow-right"></i>
        </button>
        
        <div onclick="ui.openModal('login-modal')" class="absolute bottom-10 text-xs text-gray-300 p-4 cursor-pointer">Admin Access</div>
    </div>

    <!-- 2. MAIN APP LAYOUT -->
    <div id="main-app" class="h-full w-full relative hidden">
        
        <!-- HEADER (Sticky Top) -->
        <div class="fixed top-0 left-0 w-full bg-white/90 backdrop-blur-md border-b border-gray-100 z-40 px-4 h-14 flex items-center justify-between">
            <div class="font-black text-lg tracking-tight text-gray-800 flex items-center gap-2">
                <i class="fas fa-pepper-hot text-[var(--opera-red)]"></i> Foodways
            </div>
            <div class="flex gap-3">
                <button onclick="ui.toggleSearch()" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 active:bg-gray-200">
                    <i class="fas fa-search text-xs"></i>
                </button>
                <button id="header-add-btn" onclick="app.initiateAddEntry()" class="hidden w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center active:bg-red-100">
                    <i class="fas fa-plus text-xs"></i>
                </button>
            </div>
        </div>

        <!-- SEARCH OVERLAY -->
        <div id="search-overlay" class="fixed top-14 left-0 w-full bg-white border-b border-gray-100 p-2 z-30 hidden shadow-sm transition-all">
            <input type="text" id="global-search" placeholder="Search food, country..." class="w-full bg-gray-100 text-gray-800 text-sm rounded-lg px-4 py-3 outline-none" oninput="app.handleGlobalSearch(this.value)">
        </div>

        <!-- VIEW: DASHBOARD (FEED) -->
        <div id="view-dashboard" class="view-container pt-16 px-4">
            
            <!-- KPI Grid -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-xs text-gray-400 uppercase font-bold">Total Foods</div>
                    <div class="text-2xl font-black text-gray-800" id="kpi-total">0</div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-xs text-gray-400 uppercase font-bold">Countries</div>
                    <div class="text-2xl font-black text-blue-600" id="kpi-countries">0</div>
                </div>
            </div>

            <!-- List Header -->
            <h3 class="font-bold text-gray-800 text-sm mb-3 uppercase tracking-wide">Recent Entries</h3>
            
            <!-- Card Feed -->
            <div id="card-feed" class="pb-4"></div>
            
            <div class="text-center py-4">
                <button id="btn-load-more" class="text-xs font-bold text-gray-400 bg-gray-200 px-4 py-2 rounded-full" onclick="dashboard.loadMore()">Load More</button>
            </div>
        </div>

        <!-- VIEW: MAP -->
        <div id="view-map" class="view-container pt-0 pb-[calc(60px+env(safe-area-inset-bottom))] hidden">
            <div id="map-container" class="w-full h-full bg-gray-200"></div>
            
            <!-- Map Controls -->
            <div class="absolute top-16 right-4 z-[400] flex flex-col gap-2">
                <button onclick="mapLogic.resetZoom()" class="w-10 h-10 bg-white rounded-xl shadow-lg flex items-center justify-center text-gray-700 active:bg-gray-50">
                    <i class="fas fa-compress-arrows-alt"></i>
                </button>
            </div>
            
            <!-- Simple Legend -->
            <div class="absolute bottom-20 left-4 z-[400] bg-white/90 backdrop-blur px-3 py-2 rounded-lg shadow-lg border border-gray-200 text-[10px] font-bold text-gray-600">
                <div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full bg-[var(--opera-red)]"></div> Local</div>
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-orange-400"></div> Origin</div>
            </div>
        </div>

        <!-- VIEW: PROFILE (Simple Stats/Admin) -->
        <div id="view-profile" class="view-container pt-16 px-4 hidden">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl">üë§</div>
                <h2 class="font-bold text-lg" id="profile-role">Guest User</h2>
                <button id="btn-login-profile" onclick="ui.openModal('login-modal')" class="text-xs text-[var(--opera-red)] font-bold mt-1">Login as Admin</button>
                <button id="btn-logout-profile" onclick="app.logout()" class="hidden text-xs text-gray-400 font-bold mt-1">Logout</button>
            </div>

            <h3 class="font-bold text-gray-800 text-sm mb-3">Analytics</h3>
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4 h-64">
                <canvas id="chart-type"></canvas>
            </div>
            
            <button onclick="app.exportData()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl text-sm flex items-center justify-center gap-2 active:bg-black">
                <i class="fas fa-file-csv"></i> Download Dataset
            </button>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="app.switchTab('dashboard', this)">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" onclick="app.switchTab('map', this)">
                <i class="fas fa-map-marked-alt"></i>
                <span>Map</span>
            </div>
            <div class="nav-item" onclick="app.switchTab('profile', this)">
                <i class="fas fa-user-circle"></i>
                <span>Profile</span>
            </div>
        </div>

    </div>

    <!-- 3. MODALS (FULL SCREEN OVERLAYS) -->

    <!-- DETAIL MODAL -->
    <div id="detail-modal" class="fixed inset-0 z-[2000] bg-white hidden flex flex-col modal-enter">
        <div class="h-14 border-b border-gray-100 flex items-center justify-between px-4 bg-white/95 backdrop-blur-sm sticky top-0 z-10">
            <button onclick="ui.closeModal('detail-modal')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600">
                <i class="fas fa-arrow-left"></i>
            </button>
            <span class="font-bold text-sm truncate w-40 text-center" id="dt-header-title">Detail</span>
            <div class="flex gap-2">
                <button onclick="app.exportToPDF()" class="w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button id="btn-edit-entry" onclick="app.openInputModal('edit')" class="hidden w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center">
                    <i class="fas fa-pen"></i>
                </button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div id="detail-container" class="flex-1 overflow-y-auto pb-10 bg-white">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- INPUT MODAL (Admin) -->
    <div id="input-modal" class="fixed inset-0 z-[2100] bg-gray-50 hidden flex flex-col modal-enter">
        <div class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 sticky top-0 z-10">
            <button onclick="ui.closeModal('input-modal')" class="text-gray-500 font-bold text-sm">Cancel</button>
            <span class="font-bold" id="input-title">New Entry</span>
            <button onclick="app.saveData()" id="btn-save" class="text-[var(--opera-red)] font-bold text-sm">Save</button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <input type="hidden" id="inp-id">
            
            <div class="bg-white p-4 rounded-xl border border-gray-200 space-y-3">
                <h4 class="text-xs font-bold text-gray-400 uppercase">Basic Info</h4>
                <input type="text" id="inp-name" placeholder="Food Name" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm font-bold">
                <input type="text" id="inp-country" placeholder="Country" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 space-y-3">
                <div class="flex justify-between items-center">
                    <h4 class="text-xs font-bold text-[var(--opera-red)] uppercase">Location</h4>
                    <button onclick="app.pickLocation('main')" class="text-xs bg-gray-800 text-white px-3 py-1 rounded-full">Pick on Map</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="inp-lat" placeholder="Lat" class="p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
                    <input type="text" id="inp-lng" placeholder="Lng" class="p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
                </div>
                <textarea id="inp-geometry" class="hidden"></textarea>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 space-y-3">
                <h4 class="text-xs font-bold text-orange-500 uppercase">Origins (Foodways)</h4>
                <div class="relative">
                    <input type="text" id="inp-origin-name" placeholder="Origin Food Name (Search)" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm" oninput="app.handleOriginSearch(this.value)">
                    <div id="origin-suggestions" class="hidden absolute top-full left-0 w-full bg-white border border-gray-300 z-20 shadow-xl max-h-40 overflow-y-auto"></div>
                </div>
                <input type="text" id="inp-origin-country" placeholder="Origin Country" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
                <div class="flex gap-2">
                    <button onclick="app.pickLocation('origin')" class="w-full py-2 bg-gray-100 text-gray-600 text-xs font-bold rounded-lg border border-gray-200">Set Origin Coords</button>
                </div>
                <div class="hidden grid-cols-2 gap-2">
                    <input type="text" id="inp-origin-lat"><input type="text" id="inp-origin-lng">
                </div>
                <select id="inp-conn-type" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
                    <option value="Trade">Trade</option>
                    <option value="Migration">Migration</option>
                    <option value="Colonialism">Colonialism</option>
                </select>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 space-y-3">
                <h4 class="text-xs font-bold text-gray-400 uppercase">Details</h4>
                <textarea id="inp-desc" rows="4" placeholder="Historical description..." class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm"></textarea>
                <input type="text" id="inp-image" placeholder="Image URL (Comma separated)" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
                <input type="text" id="inp-youtube" placeholder="YouTube URL (Comma separated)" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
                <input type="text" id="inp-unesco" placeholder="Heritage Status (e.g. UNESCO)" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
                <input type="text" id="inp-research" placeholder="Source Links" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm">
            </div>

            <button id="btn-delete" onclick="app.deleteData()" class="w-full py-4 text-red-500 font-bold bg-red-50 rounded-xl hidden">Delete Entry</button>
            <div class="h-20"></div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 z-[3000] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Admin Access</h3>
            <input type="text" id="login-user" placeholder="Username" class="w-full p-3 bg-gray-50 rounded-lg mb-3 border border-gray-200">
            <input type="password" id="login-pass" placeholder="Password" class="w-full p-3 bg-gray-50 rounded-lg mb-6 border border-gray-200">
            <button onclick="app.login()" id="btn-login" class="w-full bg-[var(--opera-red)] text-white font-bold py-3 rounded-xl mb-3">Login</button>
            <button onclick="ui.closeModal('login-modal')" class="w-full text-gray-400 text-sm font-bold">Cancel</button>
        </div>
    </div>

    <!-- PICKER UI -->
    <div id="picker-ui" class="fixed top-0 left-0 w-full z-[2050] hidden">
        <div class="bg-white/90 backdrop-blur p-4 border-b border-gray-200 flex justify-between items-center shadow-md">
            <span class="font-bold text-sm text-[var(--opera-red)] animate-pulse">Tap Map Location</span>
            <button onclick="app.cancelPicker()" class="bg-gray-100 px-4 py-1 rounded-full text-xs font-bold">Cancel</button>
        </div>
    </div>

    <!-- LOADER -->
    <div id="crud-loader" class="fixed inset-0 z-[5000] bg-black/30 backdrop-blur-sm hidden flex items-center justify-center">
        <div class="bg-white p-4 rounded-full shadow-2xl">
            <i class="fas fa-circle-notch fa-spin text-2xl text-[var(--opera-red)]"></i>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbw5XZBvqGjPbjB_nE2ZeJ27Ppib9-9DjSKDeVzNF-HDQU0pes9rzVn6jI9uYYjfTac/exec';
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTuPArVU91axob82CTzIgfmODCpa43OrFNIymoOVfV6UwtzUH7Yzb-yzorb3yBooJikXvsKSv10z3fV/pub?output=csv';
        
        const state = { 
            data: [], role: 'guest', editId: null, currentDetail: null,
            pagination: { page: 1, limit: 15 }, detailCache: {}, pickerTarget: null, filter: ''
        };

        function robustParse(val) {
            if (!val) return null;
            let str = String(val).trim();
            if ((str.match(/\./g) || []).length > 1) str = str.replace(/\./g, ''); 
            else if (str.includes(',') && str.includes('.')) str = str.replace(/\./g, '').replace(',', '.'); 
            else if (str.includes(',')) str = str.replace(',', '.'); 
            let n = parseFloat(str);
            return isNaN(n) ? null : (Math.abs(n) > 180 ? n/10 : n);
        }

        function transformData(item) {
             const get = (k) => item[Object.keys(item).find(x=>x.toLowerCase().includes(k))];
             const parseN = robustParse;
             return {
                id: get('id'), food_name: get('food_name')||get('name'), country: get('country'),
                lat: parseN(get('lat')), lng: parseN(get('lng')),
                origin_food_name: get('origin_food_name')||get('origin_name'), 
                origin_country: get('origin_country'),
                origin_lat: parseN(get('origin_lat')), origin_lng: parseN(get('origin_lng')),
                connection_type: get('connection_type')||get('type'), 
                youtube_url: get('youtube_url'), image_url: get('image_url'), 
                description: get('description'), geometry_json: get('geometry_json'),
                unesco_status: get('unesco_status'), research_links: get('research_links')
            };
        }

        const ui = {
            openModal: (id) => {
                const el = document.getElementById(id);
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('modal-active'), 10);
            },
            closeModal: (id) => {
                const el = document.getElementById(id);
                el.classList.remove('modal-active');
                setTimeout(() => el.classList.add('hidden'), 300);
            },
            toggleSearch: () => {
                const el = document.getElementById('search-overlay');
                el.classList.toggle('hidden');
                if(!el.classList.contains('hidden')) document.getElementById('global-search').focus();
            },
            showLoader: (show) => {
                document.getElementById('crud-loader').classList.toggle('hidden', !show);
            }
        };

        // NEW: Video Carousel Logic
        function extractYoutubeCarousel(urlStr) {
            if (!urlStr) return '';
            const urls = urlStr.split(',').map(u => u.trim()).filter(u => u);
            if (urls.length === 0) return '';
            
            return `
                <div class="mb-6">
                    <h4 class="font-bold text-gray-900 mb-3 px-4">Related Videos</h4>
                    <div class="flex overflow-x-auto gap-4 px-4 snap-x no-scrollbar pb-2">
                        ${urls.map((url, index) => {
                            let id = null;
                            if(url.includes('v=')) id = url.split('v=')[1].split('&')[0];
                            else if(url.includes('youtu.be/')) id = url.split('youtu.be/')[1];
                            else if(url.includes('embed/')) id = url.split('embed/')[1];
                            
                            // Menggunakan thumbnail kualitas tinggi
                            const thumb = id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : null;
                            const uniqueId = `yt-${id}-${index}`; // ID unik untuk setiap elemen
                            
                            return thumb ? `
                                <div class="snap-center shrink-0 relative w-72 h-40 rounded-xl overflow-hidden shadow-md border border-gray-200 bg-black group">
                                    <!-- Thumbnail Cover (Click-to-Play) -->
                                    <div class="absolute inset-0 w-full h-full cursor-pointer z-10" 
                                         onclick="this.remove(); document.getElementById('${uniqueId}').src='https://www.youtube.com/embed/${id}?autoplay=1&rel=0'">
                                        <img src="${thumb}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition">
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center shadow-lg transition transform group-hover:scale-110">
                                                <i class="fas fa-play text-white text-sm pl-1"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Iframe (Awalnya kosong agar ringan, diisi saat diklik) -->
                                    <iframe id="${uniqueId}" class="w-full h-full" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                            ` : '';
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // NEW: Detail Maps Logic
        const detailMaps = {
            geo: null, conn: null,
            init: (d) => {
                // Destroy previous maps if exist
                if(detailMaps.geo) { detailMaps.geo.remove(); detailMaps.geo = null; }
                if(detailMaps.conn) { detailMaps.conn.remove(); detailMaps.conn = null; }

                setTimeout(() => {
                    // 1. Food Distribution Map (Tetap sama)
                    if(document.getElementById('detail-geo-map')) {
                        const map1 = L.map('detail-geo-map', { zoomControl: false, attributionControl: false, dragging: false, scrollWheelZoom: false }).setView([d.lat, d.lng], 5);
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map1);
                        if(d.geometry_json) {
                            try {
                                const pts = JSON.parse(d.geometry_json);
                                L.polygon(pts, {color:'#ff1b2d', fillOpacity:0.2}).addTo(map1);
                                map1.fitBounds(pts, {padding:[20,20]});
                            } catch(e){}
                        }
                        detailMaps.geo = map1;
                    }

                    // 2. Influence Map (DIKEMBALIKAN KE LOGIKA FULL FAMILY TREE)
                    if(document.getElementById('detail-conn-map')) {
                        const map2 = L.map('detail-conn-map', { zoomControl: false, attributionControl: false, dragging: true, scrollWheelZoom: false }); // Enable dragging for complex maps
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map2);
                        
                        const bounds = L.latLngBounds();
                        let hasConnections = false;

                        // --- ALGORITMA PELACAKAN NODE (SERIAL & PARALEL) ---

                        // A. Buat Peta Anak (Siapa tua dari siapa)
                        const childrenMap = {};
                        state.data.forEach(item => {
                            if(item.origin_food_name) {
                                const pName = item.origin_food_name.toLowerCase().trim();
                                if(!childrenMap[pName]) childrenMap[pName] = [];
                                childrenMap[pName].push(item);
                            }
                        });

                        // B. Cari "Ultimate Root" (Nenek Moyang Tertinggi) dengan naik ke atas
                        let rootName = d.food_name;
                        let curr = d;
                        const pathUp = new Set([d.id]); // Mencegah infinite loop

                        while(curr && curr.origin_food_name) {
                            const parentName = curr.origin_food_name;
                            const parentNode = state.data.find(n => n.food_name.toLowerCase().trim() === parentName.toLowerCase().trim());
                            
                            rootName = parentName; // Asumsikan parent ini root sementara
                            if(parentNode) {
                                if(pathUp.has(parentNode.id)) break; 
                                pathUp.add(parentNode.id);
                                curr = parentNode;
                            } else {
                                break; // Parent cuma teks, stop di sini
                            }
                        }

                        // C. Kumpulkan SEMUA turunan dari Root (BFS Turun ke Bawah)
                        // Ini akan menangkap saudara (parallel) dan cucu (serial)
                        const familyNodes = [];
                        const queue = [rootName];
                        const visitedNames = new Set();

                        while(queue.length > 0) {
                            const pName = queue.shift();
                            const lowerP = pName.toLowerCase().trim();
                            if(visitedNames.has(lowerP)) continue;
                            visitedNames.add(lowerP);

                            // Jika nama ini ada datanya di DB, masukkan ke list
                            const realNode = state.data.find(n => n.food_name.toLowerCase().trim() === lowerP);
                            if(realNode) familyNodes.push(realNode);

                            // Cari anak-anaknya
                            if(childrenMap[lowerP]) {
                                childrenMap[lowerP].forEach(child => {
                                    familyNodes.push(child); 
                                    queue.push(child.food_name);
                                });
                            }
                        }

                        // D. Render Node Unik
                        const uniqueNodes = Array.from(new Map(familyNodes.map(item => [item.id, item])).values());
                        if(!uniqueNodes.find(n => n.id === d.id)) uniqueNodes.push(d); // Pastikan node aktif ada

                        // Sort agar node aktif di-render terakhir (paling atas)
                        uniqueNodes.sort((a, b) => (a.id === d.id) ? 1 : (b.id === d.id) ? -1 : 0);

                        uniqueNodes.forEach(node => {
                            // Gambar Garis (Dari Origin ke Node ini)
                            if(node.origin_lat && node.origin_lng && node.lat && node.lng) {
                                 L.polyline([[node.origin_lat, node.origin_lng], [node.lat, node.lng]], {
                                    color: '#fca5a5', 
                                    weight: 1.5,
                                    opacity: 0.8,
                                    dashArray: '4, 4'
                                }).addTo(map2);
                                
                                // Titik Asal (Hub)
                                L.circleMarker([node.origin_lat, node.origin_lng], { 
                                    color: '#fb923c', fillColor: '#fff', fillOpacity: 1, radius: 3, weight: 1
                                }).addTo(map2);
                                
                                bounds.extend([node.origin_lat, node.origin_lng]);
                                hasConnections = true;
                            }

                            // Gambar Marker Node
                            const isCurrent = node.id === d.id;
                            const m = L.circleMarker([node.lat, node.lng], { 
                                color: isCurrent ? '#ff1b2d' : '#ef4444', 
                                fillColor: isCurrent ? '#ff1b2d' : '#fee2e2', 
                                fillOpacity: 1, 
                                radius: isCurrent ? 6 : 4,
                                weight: isCurrent ? 0 : 1
                            }).addTo(map2);

                            // Tooltip: Hanya muncul permanen untuk Node Aktif agar tidak semrawut di HP
                            if(isCurrent) {
                                m.bindTooltip(node.food_name, { permanent: true, direction: 'top', className: 'custom-tooltip' });
                            } else {
                                // Klik node lain untuk pindah view
                                m.on('click', () => { 
                                    // Pindah detail ke node saudara/parent ini
                                    ui.closeModal('detail-modal');
                                    setTimeout(() => dashboard.showDetail(node), 300);
                                });
                            }
                            
                            bounds.extend([node.lat, node.lng]);
                        });

                        if(hasConnections || uniqueNodes.length > 0) {
                            if(bounds.isValid()) map2.fitBounds(bounds, {padding:[40,40]});
                            else map2.setView([d.lat, d.lng], 4);
                        } else {
                            // Fallback jika tidak ada koneksi
                            map2.setView([d.lat, d.lng], 4);
                            L.circleMarker([d.lat, d.lng], { color: '#ff1b2d', radius: 5 }).addTo(map2);
                        }

                        detailMaps.conn = map2;
                    }
                }, 500); // Wait for modal slide animation
            }
        };

        const mapLogic = {
            map: null, layers: [],
            init: () => {
                mapLogic.map = L.map('map-container', { zoomControl: false, attributionControl: false }).setView([20, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapLogic.map);
            },
            render: () => {
                mapLogic.layers.forEach(l => mapLogic.map.removeLayer(l));
                mapLogic.layers = [];
                const filtered = state.filter ? state.data.filter(d => d.food_name.toLowerCase().includes(state.filter.toLowerCase()) || d.country.toLowerCase().includes(state.filter.toLowerCase())) : state.data;
                const visibleIds = new Set(filtered.map(d=>d.id));
                filtered.forEach(d => { if(d.origin_food_name) { const origin = state.data.find(n => n.food_name === d.origin_food_name); if(origin) visibleIds.add(origin.id); } });

                state.data.filter(d => visibleIds.has(d.id)).forEach(d => {
                    if(!d.lat || !d.lng) return;
                    if(d.origin_lat && d.origin_lng) {
                        const line = L.polyline([[d.origin_lat, d.origin_lng], [d.lat, d.lng]], { color: '#ff1b2d', weight: 1, opacity: 0.5, dashArray: '4, 4' }).addTo(mapLogic.map);
                        mapLogic.layers.push(line);
                        const oDot = L.circleMarker([d.origin_lat, d.origin_lng], { color: '#fb923c', radius: 3, fillOpacity: 1 }).addTo(mapLogic.map);
                        mapLogic.layers.push(oDot);
                    }
                    const m = L.circleMarker([d.lat, d.lng], { color: '#ff1b2d', fillColor: '#ff1b2d', fillOpacity: 0.8, radius: 5 }).addTo(mapLogic.map);
                    m.on('click', () => { dashboard.showDetail(d); });
                    mapLogic.layers.push(m);
                });
            },
            resetZoom: () => { if(mapLogic.layers.length > 0) { const group = new L.featureGroup(mapLogic.layers); mapLogic.map.fitBounds(group.getBounds().pad(0.1)); } else mapLogic.map.setView([20,0], 2); },
            enablePicker: (cb) => {
                document.getElementById('picker-ui').classList.remove('hidden');
                const handler = (e) => { cb(e.latlng.lat, e.latlng.lng); mapLogic.map.off('click', handler); document.getElementById('picker-ui').classList.add('hidden'); ui.openModal('input-modal'); };
                mapLogic.map.on('click', handler); mapLogic.pickerCancel = handler;
            }
        };

        const dashboard = {
            renderKPI: () => {
                document.getElementById('kpi-total').innerText = state.data.length;
                document.getElementById('kpi-countries').innerText = new Set(state.data.map(d=>d.country)).size;
            },
            renderFeed: () => {
                const container = document.getElementById('card-feed');
                if(state.pagination.page === 1) container.innerHTML = '';
                const filtered = state.filter ? state.data.filter(d => d.food_name.toLowerCase().includes(state.filter.toLowerCase()) || d.country.toLowerCase().includes(state.filter.toLowerCase())) : state.data;
                const start = (state.pagination.page - 1) * state.pagination.limit;
                const end = start + state.pagination.limit;
                const pageData = filtered.slice().reverse().slice(start, end);

                pageData.forEach(d => {
                    let img = d.image_url ? d.image_url.split(',')[0] : null;
                    const card = document.createElement('div');
                    card.className = 'mobile-card p-4 flex items-center gap-4 active:bg-gray-50';
                    card.onclick = () => dashboard.showDetail(d);
                    card.innerHTML = `<div class="w-12 h-12 rounded-full bg-gray-100 flex-shrink-0 overflow-hidden border border-gray-200">${img ? `<img src="${img}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-xl">üç≤</div>`}</div><div class="flex-1 min-w-0"><h4 class="font-bold text-gray-800 text-sm truncate">${d.food_name}</h4><p class="text-xs text-gray-500 truncate"><i class="fas fa-map-marker-alt text-red-400 mr-1"></i> ${d.country}</p>${d.connection_type ? `<span class="inline-block mt-1 px-2 py-0.5 bg-orange-50 text-orange-600 text-[10px] font-bold rounded-md uppercase tracking-wide border border-orange-100">${d.connection_type}</span>` : ''}</div><i class="fas fa-chevron-right text-gray-300 text-sm"></i>`;
                    container.appendChild(card);
                });
                document.getElementById('btn-load-more').style.display = end >= filtered.length ? 'none' : 'inline-block';
            },
            loadMore: () => { state.pagination.page++; dashboard.renderFeed(); },
            showDetail: (d) => {
                state.currentDetail = d;
                ui.openModal('detail-modal');
                document.getElementById('dt-header-title').innerText = d.food_name;
                const btnEdit = document.getElementById('btn-edit-entry');
                if(state.role === 'admin') btnEdit.classList.remove('hidden'); else btnEdit.classList.add('hidden');

                const container = document.getElementById('detail-container');
                let imagesHtml = '';
                if(d.image_url) {
                    const urls = d.image_url.split(',');
                    imagesHtml = `<div class="flex overflow-x-auto gap-2 p-4 snap-x no-scrollbar">${urls.map(u => `<img src="${u.trim()}" class="snap-center w-64 h-48 object-cover rounded-xl border border-gray-200 bg-gray-100">`).join('')}</div>`;
                }

                // Generate Video Carousel
                const videoHtml = extractYoutubeCarousel(d.youtube_url);

                container.innerHTML = `
                    ${imagesHtml}
                    <div class="px-4 pb-4">
                        <h1 class="text-3xl font-black text-gray-900 mb-1 leading-tight">${d.food_name}</h1>
                        <div class="flex items-center gap-2 mb-6">
                            <span class="px-3 py-1 rounded-full bg-red-50 text-red-600 text-xs font-bold border border-red-100">${d.country}</span>
                            ${d.unesco_status ? `<span class="px-3 py-1 rounded-full bg-green-50 text-green-600 text-xs font-bold border border-green-100">UNESCO</span>` : ''}
                        </div>

                        ${d.origin_food_name ? `
                        <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
                            <div class="text-xs text-gray-400 uppercase font-bold mb-2 text-center">Evolution Path</div>
                            <div class="flex flex-col items-center gap-2">
                                <div class="text-center"><div class="font-bold text-gray-700">${d.origin_food_name}</div><div class="text-xs text-gray-500">${d.origin_country}</div></div>
                                <i class="fas fa-arrow-down text-orange-400"></i>
                                <div class="px-2 py-0.5 bg-orange-100 text-orange-600 text-[10px] font-bold rounded uppercase">${d.connection_type}</div>
                                <i class="fas fa-arrow-down text-orange-400"></i>
                                <div class="text-center"><div class="font-bold text-[var(--opera-red)] text-lg">${d.food_name}</div><div class="text-xs text-gray-500">${d.country}</div></div>
                            </div>
                        </div>` : ''}

                        <div class="prose prose-sm text-gray-600 mb-6">
                            <h4 class="font-bold text-gray-900 mb-2">History</h4>
                            <p class="whitespace-pre-line">${d.description || 'No description provided.'}</p>
                        </div>

                        <!-- VIDEO CAROUSEL -->
                        ${videoHtml}
                        
                        <!-- MAPS SECTION -->
                        <div class="mb-6">
                            <h4 class="font-bold text-gray-900 mb-3">Geographic Distribution</h4>
                            ${d.geometry_json ? `<div id="detail-geo-map" class="h-48 w-full bg-gray-200 rounded-xl border border-gray-200"></div>` : '<div class="text-xs text-gray-400 italic">No distribution data.</div>'}
                        </div>

                        <div class="mb-6">
                            <h4 class="font-bold text-gray-900 mb-3">Influence Map</h4>
                            ${d.origin_lat ? `<div id="detail-conn-map" class="h-48 w-full bg-gray-200 rounded-xl border border-gray-200"></div>` : '<div class="text-xs text-gray-400 italic">No origin coordinates.</div>'}
                        </div>

                        ${d.research_links ? `
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-8">
                            <h4 class="font-bold text-blue-800 text-xs uppercase mb-2">Sources</h4>
                            <div class="flex flex-col gap-2 text-xs text-blue-600 truncate">
                                ${d.research_links.split(',').map(l => `<a href="${l}" target="_blank" class="underline block truncate">${l}</a>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;

                // Initialize Maps after content render
                detailMaps.init(d);
            }
        };

        const app = {
            init: () => {
                Papa.parse(CSV_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => { if(res.data.length) { state.data = res.data.map(transformData).filter(x => x.lat && x.lng); document.getElementById('loading-indicator').innerHTML = '<i class="fas fa-check text-green-500"></i> Ready'; document.getElementById('btn-enter').classList.remove('hidden'); } }
                });
            },
            enterApp: () => { document.getElementById('landing-page').classList.add('opacity-0'); setTimeout(() => { document.getElementById('landing-page').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); dashboard.renderKPI(); dashboard.renderFeed(); mapLogic.init(); mapLogic.render(); }, 500); },
            switchTab: (tab, el) => { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-map').classList.add('hidden'); document.getElementById('view-profile').classList.add('hidden'); document.getElementById('view-'+tab).classList.remove('hidden'); if(tab === 'map') { setTimeout(() => mapLogic.map.invalidateSize(), 100); } },
            handleGlobalSearch: (val) => { state.filter = val; state.pagination.page = 1; dashboard.renderFeed(); mapLogic.render(); },
            initiateAddEntry: () => { state.editId = null; document.querySelectorAll('#input-modal input, #input-modal textarea').forEach(e => e.value = ''); document.getElementById('input-title').innerText = 'New Food Entry'; document.getElementById('btn-delete').classList.add('hidden'); ui.openModal('input-modal'); },
            openInputModal: (mode) => { if(mode === 'edit' && state.currentDetail) { const d = state.currentDetail; state.editId = d.id; document.getElementById('inp-id').value = d.id; document.getElementById('inp-name').value = d.food_name; document.getElementById('inp-country').value = d.country; document.getElementById('inp-lat').value = d.lat; document.getElementById('inp-lng').value = d.lng; document.getElementById('inp-desc').value = d.description; document.getElementById('inp-origin-name').value = d.origin_food_name || ''; document.getElementById('inp-origin-country').value = d.origin_country || ''; document.getElementById('inp-origin-lat').value = d.origin_lat || ''; document.getElementById('inp-origin-lng').value = d.origin_lng || ''; document.getElementById('inp-conn-type').value = d.connection_type || 'Trade'; document.getElementById('inp-image').value = d.image_url || ''; document.getElementById('inp-youtube').value = d.youtube_url || ''; document.getElementById('inp-unesco').value = d.unesco_status || ''; document.getElementById('inp-research').value = d.research_links || ''; document.getElementById('input-title').innerText = 'Edit Entry'; document.getElementById('btn-delete').classList.remove('hidden'); ui.closeModal('detail-modal'); ui.openModal('input-modal'); } },
            pickLocation: (target) => { state.pickerTarget = target; ui.closeModal('input-modal'); document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-profile').classList.add('hidden'); document.getElementById('view-map').classList.remove('hidden'); mapLogic.enablePicker((lat, lng) => { if(state.pickerTarget === 'main') { document.getElementById('inp-lat').value = lat.toFixed(5); document.getElementById('inp-lng').value = lng.toFixed(5); } else { document.getElementById('inp-origin-lat').value = lat.toFixed(5); document.getElementById('inp-origin-lng').value = lng.toFixed(5); } }); },
            cancelPicker: () => { if(mapLogic.map && mapLogic.pickerCancel) { mapLogic.map.off('click', mapLogic.pickerCancel); document.getElementById('picker-ui').classList.add('hidden'); ui.openModal('input-modal'); } },
            login: () => { const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value; const btn = document.getElementById('btn-login'); btn.innerText = 'Verifying...'; const form = new URLSearchParams(); form.append('action', 'login'); form.append('username', u); form.append('password', p); fetch(GAS_URL, { method: 'POST', body: form }).then(r=>r.json()).then(d => { if(d.status === 'success') { state.role = 'admin'; document.getElementById('profile-role').innerText = 'Admin Contributor'; document.getElementById('btn-login-profile').classList.add('hidden'); document.getElementById('btn-logout-profile').classList.remove('hidden'); document.getElementById('header-add-btn').classList.remove('hidden'); ui.closeModal('login-modal'); } else { alert('Invalid Credentials'); } btn.innerText = 'Login'; }).catch(e => { alert('Network Error'); btn.innerText = 'Login'; }); },
            logout: () => { state.role = 'guest'; document.getElementById('profile-role').innerText = 'Guest User'; document.getElementById('btn-login-profile').classList.remove('hidden'); document.getElementById('btn-logout-profile').classList.add('hidden'); document.getElementById('header-add-btn').classList.add('hidden'); },
            saveData: () => { const d = { id: state.editId || '', food_name: document.getElementById('inp-name').value, country: document.getElementById('inp-country').value, lat: document.getElementById('inp-lat').value, lng: document.getElementById('inp-lng').value, description: document.getElementById('inp-desc').value, origin_food_name: document.getElementById('inp-origin-name').value, origin_country: document.getElementById('inp-origin-country').value, origin_lat: document.getElementById('inp-origin-lat').value, origin_lng: document.getElementById('inp-origin-lng').value, connection_type: document.getElementById('inp-conn-type').value, image_url: document.getElementById('inp-image').value, youtube_url: document.getElementById('inp-youtube').value, unesco_status: document.getElementById('inp-unesco').value, research_links: document.getElementById('inp-research').value }; ui.showLoader(true); const action = state.editId ? 'update' : 'insert'; const form = new URLSearchParams(); form.append('action', action); form.append('data', JSON.stringify(d)); if (action === 'update' && state.currentDetail) { form.append('original_data', JSON.stringify({ food_name: state.currentDetail.food_name, lat: state.currentDetail.lat, lng: state.currentDetail.lng })); } fetch(GAS_URL, { method: 'POST', body: form }).then(r=>r.json()).then(res => { ui.showLoader(false); if(res.status === 'success') { alert('Saved!'); location.reload(); } else alert(res.message); }); },
            deleteData: () => { if(!confirm('Delete this entry?')) return; ui.showLoader(true); const form = new URLSearchParams(); form.append('action', 'delete'); form.append('id', state.editId); form.append('data', JSON.stringify({ food_name: state.currentDetail.food_name, lat: state.currentDetail.lat, lng: state.currentDetail.lng })); fetch(GAS_URL, { method: 'POST', body: form }).then(r=>r.json()).then(res => { ui.showLoader(false); if(res.status === 'success') location.reload(); else alert(res.message); }); },
            exportToPDF: async () => { alert("PDF export is heavy. Please wait..."); const d = state.currentDetail; const element = document.createElement('div'); element.innerHTML = `<h1>${d.food_name}</h1><p>${d.description}</p>`; await html2pdf().from(element).save(`${d.food_name}.pdf`); }
        };

        app.init();
    </script>
</body>
</html>
