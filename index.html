<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Foodways Mobile</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- HTML2PDF & HTML2CANVAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        opera: {
                            red: '#ff1b2d',
                            midnight: '#1a1a2e',
                            gold: '#d4af37',
                            silver: '#f3f4f6',
                            text: '#333333'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --opera-red: #ff1b2d;
            --opera-midnight: #1a1a2e;
            --opera-gold: #d4af37;
            --opera-bg: #f8f9fa;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            background-color: var(--opera-bg); 
            color: #1a1a1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; 
            height: 100vh;
            height: 100dvh; 
            overscroll-behavior-y: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .mobile-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            margin-bottom: 12px;
            border: 1px solid #f0f0f0;
            transition: transform 0.1s;
        }
        .mobile-card:active { transform: scale(0.98); }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #eee;
            padding-bottom: var(--safe-bottom);
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: calc(60px + var(--safe-bottom));
            z-index: 4000; /* Lower than Modal, Higher than Map */
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 10px;
            font-weight: 600;
            width: 100%;
            height: 100%;
            transition: color 0.2s;
        }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: var(--opera-midnight); }

        .view-container {
            height: 100%;
            width: 100%;
            overflow-y: auto;
            padding-bottom: calc(70px + var(--safe-bottom));
            background: var(--opera-bg);
        }

        /* Leaflet Tweaks */
        .leaflet-container { background: #e0e0e0; font-family: inherit; }
        .custom-tooltip {
            background: white !important; 
            border: 2px solid var(--opera-red) !important;
            color: black !important;
            border-radius: 4px !important;
            font-weight: bold !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
            font-size: 10px !important;
            padding: 2px 5px !important;
        }

        /* GEO EDITOR STYLES */
        .geo-marker-icon {
            background: white;
            border: 2px solid var(--opera-red);
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(0,0,0,0.4);
            cursor: move;
        }

        .modal-enter { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-active { transform: translateY(0); }
        
        #landing-page-bg {
            background-image: url('https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body>

    <!-- 1. LANDING PAGE (Z-60000) -->
    <div id="landing-page" class="fixed inset-0 z-[60000] flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500 overflow-hidden">
        <div id="landing-page-bg" class="absolute inset-0 z-0"></div>
        <div class="absolute inset-0 bg-[#1a1a2e]/80 z-0"></div>

        <div class="mb-6 relative z-10">
            <div class="absolute inset-0 bg-red-600 rounded-full animate-ping opacity-50"></div>
            <div class="w-24 h-24 bg-white border-4 border-white rounded-full flex items-center justify-center relative z-10 shadow-2xl">
                <i class="fas fa-pepper-hot text-4xl text-opera-red"></i>
            </div>
        </div>
        <h1 class="text-5xl font-black text-white mb-2 relative z-10 drop-shadow-lg tracking-tight">Foodways</h1>
        <p class="text-sm text-opera-gold uppercase tracking-[0.3em] font-bold mb-10 relative z-10 drop-shadow-sm">Shared Heritage</p>
        
        <div id="loading-indicator" class="flex flex-col items-center relative z-10 mb-8">
            <div class="w-12 h-1 bg-white/20 rounded-full overflow-hidden">
                <div class="h-full bg-opera-gold animate-[loading_1s_ease-in-out_infinite]" style="width: 50%"></div>
            </div>
            <span class="text-[10px] text-gray-300 font-medium mt-2 uppercase tracking-wider">Syncing Database...</span>
        </div>
        <style>@keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }</style>

        <button id="btn-enter" onclick="window.app.enterApp()" class="hidden w-full max-w-xs bg-opera-red text-white font-bold py-4 rounded-xl shadow-xl shadow-red-900/30 active:scale-95 transition-transform flex items-center justify-center gap-2 relative z-10 border-t border-white/20">
            Start Exploring <i class="fas fa-arrow-right ml-1"></i>
        </button>
        
        <div onclick="window.ui.openModal('login-modal')" class="absolute bottom-8 text-[10px] text-white/30 font-bold uppercase tracking-widest p-4 cursor-pointer z-10 hover:text-white transition-colors">Admin Access</div>
    </div>

    <!-- 2. MAIN APP LAYOUT -->
    <div id="main-app" class="h-full w-full relative hidden">
        
        <!-- HEADER (Z-4000) - Lower than Modals -->
        <div class="fixed top-0 left-0 w-full bg-opera-midnight text-white border-b border-gray-800 z-[4000] px-4 h-14 flex items-center justify-between shadow-md">
            <div class="font-black text-lg tracking-tight flex items-center gap-2">
                <i class="fas fa-pepper-hot text-opera-red"></i> Foodways
            </div>
            <div class="flex gap-3">
                <button onclick="window.ui.toggleSearch()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-colors">
                    <i class="fas fa-search text-xs"></i>
                </button>
                <button id="header-add-btn" onclick="window.app.initiateAddEntry()" class="hidden w-8 h-8 bg-opera-red text-white rounded-full flex items-center justify-center active:scale-95 shadow-lg shadow-red-900/50">
                    <i class="fas fa-plus text-xs"></i>
                </button>
            </div>
        </div>

        <!-- SEARCH OVERLAY (Z-4050) -->
        <div id="search-overlay" class="fixed top-14 left-0 w-full bg-white border-b border-gray-100 p-2 z-[4050] hidden shadow-sm transition-all">
            <input type="text" id="global-search" placeholder="Search food, country..." class="w-full bg-gray-100 text-gray-800 text-sm rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-opera-gold/50" oninput="window.app.handleGlobalSearch(this.value)">
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-container pt-24 px-4">
            <div class="h-4"></div>
            
            <!-- KPI -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-opera-red/5 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                    <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Total Foods</div>
                    <div class="text-3xl font-black text-opera-midnight mt-1" id="kpi-total">0</div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-opera-gold/10 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                    <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Countries</div>
                    <div class="text-3xl font-black text-opera-gold mt-1" id="kpi-countries">0</div>
                </div>
            </div>

            <div class="flex items-center justify-between mb-3">
                <h3 class="font-bold text-gray-800 text-sm uppercase tracking-wide">Recent Entries</h3>
                <span class="text-[10px] bg-opera-midnight text-white px-2 py-0.5 rounded font-bold">LIVE</span>
            </div>
            
            <div id="card-feed" class="pb-4"></div>
            
            <div class="text-center py-4">
                <button id="btn-load-more" class="text-xs font-bold text-opera-midnight bg-gray-200 px-6 py-3 rounded-full hover:bg-gray-300 transition-colors" onclick="window.dashboard.loadMore()">Load More</button>
            </div>
        </div>

        <!-- VIEW: MAP -->
        <div id="view-map" class="view-container pt-0 pb-[calc(60px+env(safe-area-inset-bottom))] hidden">
            <div id="map-container" class="w-full h-full bg-gray-200"></div>
            <div class="absolute top-16 right-4 z-[300] flex flex-col gap-2">
                <button onclick="window.mapLogic.resetZoom()" class="w-10 h-10 bg-white rounded-xl shadow-lg flex items-center justify-center text-gray-700 active:bg-gray-50 border border-gray-100">
                    <i class="fas fa-compress-arrows-alt"></i>
                </button>
            </div>
            <div class="absolute bottom-20 left-4 z-[300] bg-white/95 backdrop-blur px-4 py-3 rounded-xl shadow-xl border border-gray-200 text-[10px] font-bold text-gray-600">
                <div class="flex items-center gap-2 mb-2"><div class="w-2 h-2 rounded-full bg-opera-red ring-2 ring-red-100"></div> Local (Red)</div>
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-opera-gold ring-2 ring-yellow-100"></div> Origin (Gold)</div>
            </div>
        </div>

        <!-- VIEW: PROFILE -->
        <div id="view-profile" class="view-container pt-24 px-4 hidden">
            <div class="h-4"></div>
            <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 mb-6 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-opera-midnight via-opera-red to-opera-gold"></div>
                <div class="w-20 h-20 bg-gray-50 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl border-4 border-white shadow-lg">ðŸ‘¤</div>
                <h2 class="font-black text-xl text-opera-midnight" id="profile-role">Guest User</h2>
                <div class="mt-4 flex justify-center gap-2">
                    <button id="btn-login-profile" onclick="window.ui.openModal('login-modal')" class="text-xs bg-opera-red text-white px-4 py-2 rounded-full font-bold shadow-lg shadow-red-200">Login Admin</button>
                    <button id="btn-logout-profile" onclick="window.app.logout()" class="hidden text-xs bg-gray-200 text-gray-600 px-4 py-2 rounded-full font-bold">Logout</button>
                </div>
            </div>

            <h3 class="font-bold text-gray-800 text-sm mb-4 uppercase tracking-wide flex items-center gap-2">
                <span class="w-1 h-4 bg-opera-gold rounded-full"></span> Interaction Types
            </h3>
            
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6 flex items-center justify-center relative">
                <div class="w-full h-64 relative">
                    <canvas id="chart-type"></canvas>
                </div>
            </div>
            
            <button onclick="window.app.exportData()" class="w-full bg-opera-midnight text-white font-bold py-4 rounded-xl text-sm flex items-center justify-center gap-3 active:scale-95 transition-transform mb-10 shadow-xl shadow-blue-900/20">
                <i class="fas fa-file-csv text-opera-gold"></i> Download Dataset
            </button>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="window.app.switchTab('dashboard', this)">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" onclick="window.app.switchTab('map', this)">
                <i class="fas fa-map-marked-alt"></i>
                <span>Map</span>
            </div>
            <div class="nav-item" onclick="window.app.switchTab('profile', this)">
                <i class="fas fa-chart-pie"></i>
                <span>Analytics</span>
            </div>
        </div>
    </div>

    <!-- 3. MODALS -->

    <!-- DETAIL MODAL (Z-5000 - Higher than Header Z-4000) -->
    <div id="detail-modal" class="fixed inset-0 z-[5000] bg-white hidden flex flex-col modal-enter">
        <div class="h-14 border-b border-gray-100 flex items-center justify-between px-4 bg-white/95 backdrop-blur-sm sticky top-0 z-10">
            <button onclick="window.ui.closeModal('detail-modal')" class="w-8 h-8 rounded-full bg-gray-50 hover:bg-gray-100 flex items-center justify-center text-gray-800 transition-colors">
                <i class="fas fa-arrow-left"></i>
            </button>
            <span class="font-bold text-sm truncate w-40 text-center text-opera-midnight" id="dt-header-title">Detail</span>
            <div class="flex gap-2">
                <button onclick="window.app.exportToPDF()" class="w-8 h-8 rounded-full bg-opera-midnight text-white flex items-center justify-center hover:bg-gray-800 transition-colors shadow-lg shadow-blue-900/20">
                    <i class="fas fa-file-pdf text-xs"></i>
                </button>
                <button id="btn-edit-entry" onclick="window.app.openInputModal('edit')" class="hidden w-8 h-8 rounded-full bg-opera-red text-white flex items-center justify-center shadow-lg shadow-red-500/30">
                    <i class="fas fa-pen text-xs"></i>
                </button>
            </div>
        </div>
        <div id="detail-container" class="flex-1 overflow-y-auto pb-10 bg-white"></div>
    </div>

    <!-- INPUT MODAL (Admin) (Z-5100) -->
    <div id="input-modal" class="fixed inset-0 z-[5100] bg-gray-50 hidden flex flex-col modal-enter">
        <div class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 sticky top-0 z-10">
            <button onclick="window.ui.closeModal('input-modal')" class="text-gray-400 font-bold text-xs uppercase tracking-wide hover:text-gray-600">Cancel</button>
            <span class="font-bold text-opera-midnight" id="input-title">New Entry</span>
            <button onclick="window.app.saveData()" id="btn-save" class="bg-opera-midnight text-white px-4 py-1.5 rounded-full font-bold text-xs shadow-lg shadow-blue-900/20">Save</button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <input type="hidden" id="inp-id">
            
            <div class="bg-white p-5 rounded-2xl border border-gray-100 space-y-4 shadow-sm">
                <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest border-b pb-2">Basic Info</h4>
                <input type="text" id="inp-name" placeholder="Food Name" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm font-bold focus:ring-2 focus:ring-opera-red/20 outline-none transition-all">
                <input type="text" id="inp-country" placeholder="Country" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm focus:ring-2 focus:ring-opera-red/20 outline-none transition-all">
            </div>

            <div class="bg-white p-5 rounded-2xl border border-gray-100 space-y-4 shadow-sm">
                <div class="flex justify-between items-center border-b pb-2">
                    <h4 class="text-[10px] font-black text-opera-red uppercase tracking-widest">Location & Distribution</h4>
                </div>
                <!-- Tombol Pick on Map & Draw Area (BERDAMPINGAN) -->
                <div class="flex gap-2">
                    <button onclick="window.app.pickLocation('main')" class="flex-1 text-[10px] bg-opera-midnight text-white px-3 py-3 rounded-xl font-bold hover:bg-gray-800 transition-colors flex items-center justify-center gap-2 shadow-md">
                        <i class="fas fa-map-pin"></i> Pick on Map
                    </button>
                    <button onclick="window.geoEditor.start()" class="flex-1 text-[10px] bg-white text-opera-red border border-opera-red px-3 py-3 rounded-xl font-bold hover:bg-red-50 transition-colors flex items-center justify-center gap-2 shadow-sm">
                        <i class="fas fa-draw-polygon"></i> Draw Area
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="inp-lat" placeholder="Latitude" class="p-3 bg-gray-50 rounded-xl border border-gray-200 text-xs font-mono">
                    <input type="text" id="inp-lng" placeholder="Longitude" class="p-3 bg-gray-50 rounded-xl border border-gray-200 text-xs font-mono">
                </div>
                <!-- Geometry JSON Store -->
                <textarea id="inp-geometry" class="hidden"></textarea>
                <div class="text-[10px] text-gray-400 italic" id="geo-status-text">Area not set</div>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-gray-100 space-y-4 shadow-sm">
                <h4 class="text-[10px] font-black text-opera-gold uppercase tracking-widest border-b pb-2">Origins (Heritage)</h4>
                <div class="relative">
                    <input type="text" id="inp-origin-name" placeholder="Origin Food Name" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm font-bold" oninput="window.app.handleOriginSearch(this.value)">
                    <div id="origin-suggestions" class="hidden absolute top-full left-0 w-full bg-white border border-gray-300 z-50 shadow-xl max-h-40 overflow-y-auto rounded-b-xl"></div>
                </div>
                <input type="text" id="inp-origin-country" placeholder="Origin Country" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm">
                <button onclick="window.app.pickLocation('origin')" class="w-full py-3 bg-gray-50 text-gray-500 text-xs font-bold rounded-xl border border-gray-200 hover:bg-gray-100 border-dashed">
                    <i class="fas fa-crosshairs mr-1"></i> Set Origin Coordinates
                </button>
                <div class="hidden grid-cols-2 gap-2">
                    <input type="text" id="inp-origin-lat"><input type="text" id="inp-origin-lng">
                </div>
                <div class="relative">
                    <select id="inp-conn-type" class="w-full p-3 bg-white rounded-xl border border-gray-200 text-sm appearance-none font-bold text-gray-600">
                        <option value="Trade">Trade (Gold)</option>
                        <option value="Migration">Migration (Red)</option>
                        <option value="Colonialism">Colonialism (Navy)</option>
                    </select>
                    <i class="fas fa-chevron-down absolute right-4 top-4 text-gray-400 text-xs"></i>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-gray-100 space-y-4 shadow-sm">
                <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest border-b pb-2">Deep Dive</h4>
                <textarea id="inp-desc" rows="4" placeholder="Historical context & narrative..." class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm leading-relaxed"></textarea>
                <input type="text" id="inp-image" placeholder="Image URL (Comma separated)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm">
                <input type="text" id="inp-youtube" placeholder="YouTube URL" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm">
                <input type="text" id="inp-unesco" placeholder="Heritage Status" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm">
                <input type="text" id="inp-research" placeholder="Research Links" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm">
            </div>

            <button id="btn-delete" onclick="window.app.deleteData()" class="w-full py-4 text-red-500 font-bold bg-red-50 rounded-xl border border-red-100 hover:bg-red-100 transition-colors hidden">
                <i class="fas fa-trash-alt mr-2"></i> Delete Entry
            </button>
            <div class="h-20"></div>
        </div>
    </div>

    <!-- GEO EDITOR (Full Screen Overlay) (Z-6000) -->
    <div id="geo-editor" class="fixed inset-0 z-[6000] bg-white hidden flex flex-col">
        <!-- Editor Header -->
        <div class="h-14 bg-opera-midnight text-white flex items-center justify-between px-4 shadow-lg z-10">
            <button onclick="window.geoEditor.cancel()" class="text-xs font-bold bg-white/10 px-3 py-1.5 rounded-md">Cancel</button>
            <div class="font-bold text-sm tracking-wide flex items-center gap-2">
                <i class="fas fa-draw-polygon text-opera-gold"></i> Distribution Editor
            </div>
            <button onclick="window.geoEditor.finish()" class="text-xs font-bold bg-green-500 text-white px-4 py-1.5 rounded-md shadow-lg shadow-green-900/50">Done</button>
        </div>
        
        <!-- Editor Instructions -->
        <div class="absolute top-16 left-1/2 transform -translate-x-1/2 z-[400] bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-xl border border-gray-200 text-[10px] font-bold text-gray-600 flex items-center gap-2 pointer-events-none">
            <i class="fas fa-hand-pointer text-opera-red"></i> Tap to add points. Drag dots to adjust.
        </div>

        <!-- The Map -->
        <div id="geo-map" class="flex-1 bg-gray-200"></div>
    </div>

    <!-- LOGIN MODAL (Z-5500) -->
    <div id="login-modal" class="fixed inset-0 z-[5500] bg-opera-midnight/80 backdrop-blur-sm hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-opera-red"></div>
            <h3 class="text-2xl font-black text-opera-midnight mb-1 text-center">Admin Access</h3>
            <p class="text-xs text-gray-400 text-center mb-6">Restricted Area</p>
            <div class="space-y-4">
                <input type="text" id="login-user" placeholder="Username" class="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 text-center font-bold focus:ring-2 focus:ring-opera-red/20 outline-none">
                <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full p-4 bg-gray-50 rounded-xl border border-gray-200 text-center font-bold focus:ring-2 focus:ring-opera-red/20 outline-none">
            </div>
            <button onclick="window.app.login()" id="btn-login" class="w-full bg-opera-midnight text-white font-bold py-4 rounded-xl mt-6 shadow-xl shadow-blue-900/20 active:scale-95 transition-transform">Verify Credentials</button>
            <button onclick="window.ui.closeModal('login-modal')" class="w-full text-gray-400 text-xs font-bold mt-4 hover:text-gray-600">CANCEL</button>
        </div>
    </div>

    <!-- PICKER UI (Z-5050) -->
    <div id="picker-ui" class="fixed top-0 left-0 w-full z-[5050] hidden">
        <div class="bg-white/90 backdrop-blur-md p-4 border-b border-gray-200 flex justify-between items-center shadow-lg">
            <span class="font-bold text-sm text-opera-red animate-pulse"><i class="fas fa-map-pin mr-1"></i> Tap Map Location</span>
            <button onclick="window.app.cancelPicker()" class="bg-gray-100 px-4 py-1.5 rounded-full text-xs font-bold text-gray-600 hover:bg-gray-200">Cancel</button>
        </div>
    </div>

    <!-- LOADER (Z-70000) -->
    <div id="crud-loader" class="fixed inset-0 z-[70000] bg-opera-midnight/50 backdrop-blur-sm hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-3">
            <i class="fas fa-circle-notch fa-spin text-3xl text-opera-red"></i>
            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Processing...</span>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbw5XZBvqGjPbjB_nE2ZeJ27Ppib9-9DjSKDeVzNF-HDQU0pes9rzVn6jI9uYYjfTac/exec';
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTuPArVU91axob82CTzIgfmODCpa43OrFNIymoOVfV6UwtzUH7Yzb-yzorb3yBooJikXvsKSv10z3fV/pub?output=csv';
        
        window.handleImageError = function(el) {
            el.parentElement.innerHTML = '<div class="w-full h-full flex items-center justify-center text-xl text-gray-300"><i class="fas fa-utensils"></i></div>';
        };

        const state = { 
            data: [], role: 'guest', editId: null, currentDetail: null,
            pagination: { page: 1, limit: 15 }, detailCache: {}, pickerTarget: null, filter: '',
            charts: {} 
        };

        // --- VALIDATOR HELPER (ULTRA STRICT) ---
        const isValidStr = (s) => {
            if (!s || typeof s !== 'string') return false;
            const clean = s.trim().toLowerCase();
            // Block generic placeholders too
            return clean.length > 0 && clean !== 'null' && clean !== 'undefined' && clean !== '-' && clean !== 'nan' && clean !== '.';
        };

        // --- HELPER UNTUK YOUTUBE ---
        function extractYoutubeCarousel(urlStr) {
            if (!urlStr) return '';
            const urls = urlStr.split(',').map(u => u.trim()).filter(u => u);
            if (urls.length === 0) return '';
            return `
                <div class="mb-6">
                    <h4 class="font-bold text-gray-900 mb-3 px-4 text-xs uppercase tracking-wider">Visual Archive</h4>
                    <div class="flex overflow-x-auto gap-4 px-4 snap-x no-scrollbar pb-2">
                        ${urls.map((url) => {
                            let id = null;
                            if(url.includes('v=')) id = url.split('v=')[1].split('&')[0];
                            else if(url.includes('youtu.be/')) id = url.split('youtu.be/')[1];
                            else if(url.includes('embed/')) id = url.split('embed/')[1];
                            return id ? `
                                <div class="snap-center shrink-0 relative w-72 h-40 rounded-2xl overflow-hidden shadow-lg border border-gray-100 bg-black group">
                                    <iframe class="w-full h-full" src="https://www.youtube.com/embed/${id}?rel=0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
                                </div>` : '';
                        }).join('')}
                    </div>
                </div>`;
        }

        // --- GEO EDITOR LOGIC (AUDITED) ---
        window.geoEditor = {
            map: null, layer: null, points: [], markers: [],
            
            start: () => {
                window.ui.closeModal('input-modal');
                document.getElementById('geo-editor').classList.remove('hidden');
                
                if(!window.geoEditor.map) {
                    window.geoEditor.map = L.map('geo-map', { zoomControl: false }).setView([20,0], 2);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
                        noWrap: true,
                        bounds: [[-90, -180], [90, 180]],
                        maxBounds: [[-90, -180], [90, 180]],
                        maxBoundsViscosity: 1.0
                    }).addTo(window.geoEditor.map);
                    window.geoEditor.map.on('click', e => window.geoEditor.addPoint(e.latlng));
                }
                
                window.geoEditor.points = [];
                window.geoEditor.markers.forEach(m => window.geoEditor.map.removeLayer(m));
                window.geoEditor.markers = [];
                if(window.geoEditor.layer) window.geoEditor.map.removeLayer(window.geoEditor.layer);

                const existingVal = document.getElementById('inp-geometry').value;
                if(existingVal) {
                    try {
                        const parsed = JSON.parse(existingVal);
                        if(Array.isArray(parsed) && parsed.length > 0) {
                             parsed.forEach(pt => window.geoEditor.addPoint(L.latLng(pt[0], pt[1])));
                             if(parsed.length > 1) {
                                 const bounds = L.polygon(parsed).getBounds();
                                 window.geoEditor.map.fitBounds(bounds, {padding:[50,50]});
                             } else {
                                 window.geoEditor.map.setView(parsed[0], 5);
                             }
                        }
                    } catch(e) { console.error("Invalid GeoJSON", e); }
                } else {
                    const lat = document.getElementById('inp-lat').value;
                    const lng = document.getElementById('inp-lng').value;
                    if(lat && lng) window.geoEditor.map.setView([lat, lng], 8);
                }
                
                setTimeout(()=>window.geoEditor.map.invalidateSize(), 200);
            },

            addPoint: (latlng) => {
                const m = L.marker(latlng, { 
                    draggable: true, 
                    icon: L.divIcon({ className: 'geo-marker-icon', iconSize: [12,12] }) 
                }).addTo(window.geoEditor.map);
                m.on('drag', () => window.geoEditor.updatePoly());
                window.geoEditor.markers.push(m);
                window.geoEditor.updatePoly();
            },

            updatePoly: () => {
                window.geoEditor.points = window.geoEditor.markers.map(m => [m.getLatLng().lat, m.getLatLng().lng]);
                if(window.geoEditor.layer) window.geoEditor.map.removeLayer(window.geoEditor.layer);
                if(window.geoEditor.points.length > 2) {
                    window.geoEditor.layer = L.polygon(window.geoEditor.points, {color:'#ff1b2d', weight:2, fillOpacity: 0.2}).addTo(window.geoEditor.map);
                } else if(window.geoEditor.points.length > 1) {
                    window.geoEditor.layer = L.polyline(window.geoEditor.points, {color:'#ff1b2d', weight:2, dashArray: '5,5'}).addTo(window.geoEditor.map);
                }
            },

            finish: () => {
                if(window.geoEditor.points.length > 0) {
                    document.getElementById('inp-geometry').value = JSON.stringify(window.geoEditor.points);
                    document.getElementById('geo-status-text').innerText = `${window.geoEditor.points.length} points set`;
                    document.getElementById('geo-status-text').className = "text-[10px] text-green-600 font-bold";
                } else {
                    document.getElementById('inp-geometry').value = "";
                    document.getElementById('geo-status-text').innerText = "Area cleared";
                }
                window.geoEditor.cancel();
            },

            cancel: () => {
                document.getElementById('geo-editor').classList.add('hidden');
                window.ui.openModal('input-modal');
            }
        };

        // --- GHOST MAPPING (PDF) ---
        const ghostId = 'ghost-map-container';
        let ghost = document.getElementById(ghostId);
        if (!ghost) {
            ghost = document.createElement('div');
            ghost.id = ghostId;
            ghost.style.position = 'fixed'; ghost.style.left = '-9999px'; ghost.style.top = '0';
            ghost.style.width = '800px'; ghost.style.height = '400px'; ghost.style.zIndex = '-9999';
            document.body.appendChild(ghost);
        }

        const generateMapSnapshot = async (d, type) => {
            if (ghost._leaflet_id) { ghost._leaflet_id = null; }
            ghost.innerHTML = ''; 
            const map = L.map(ghostId, { zoomControl: false, attributionControl: false, fadeAnimation: false, zoomAnimation: false, preferCanvas: true });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                noWrap: true,
                bounds: [[-90, -180], [90, 180]],
                maxBounds: [[-90, -180], [90, 180]],
                maxBoundsViscosity: 1.0
            }).addTo(map);
            const bounds = L.latLngBounds();
            
            if (type === 'geo') {
                map.setView([d.lat, d.lng], 5);
                if(d.geometry_json) {
                    try {
                        const pts = JSON.parse(d.geometry_json);
                        L.polygon(pts, {color:'#ff1b2d', fillOpacity:0.2}).addTo(map);
                        map.fitBounds(pts, {padding:[50,50], animate: false});
                    } catch(e){ L.circleMarker([d.lat, d.lng], { color: '#ff1b2d', radius: 5 }).addTo(map); }
                } else {
                      L.circleMarker([d.lat, d.lng], { color: '#ff1b2d', radius: 5 }).addTo(map);
                }
            } else if (type === 'conn') {
                // --- NEW FAMILY TREE LOGIC FOR PDF ---
                
                // 1. Build Children Map
                const childrenMap = {};
                state.data.forEach(item => {
                    if(isValidStr(item.origin_food_name)) {
                        const pName = item.origin_food_name.toLowerCase().trim();
                        if(!childrenMap[pName]) childrenMap[pName] = [];
                        childrenMap[pName].push(item);
                    }
                });

                // 2. Find Root
                let rootName = d.food_name;
                let curr = d;
                const pathUp = new Set([d.id]);
                
                while(curr && isValidStr(curr.origin_food_name)) {
                    const parentName = curr.origin_food_name;
                    const parentNode = state.data.find(n => n.food_name.toLowerCase().trim() === parentName.toLowerCase().trim());
                    rootName = parentName; 
                    if(parentNode) {
                        if(pathUp.has(parentNode.id)) break; 
                        pathUp.add(parentNode.id);
                        curr = parentNode;
                    } else {
                        break; 
                    }
                }

                // 3. BFS Down
                const familyNodes = [];
                const queue = [rootName];
                const visitedNames = new Set();
                
                while(queue.length > 0) {
                    const pName = queue.shift();
                    const lowerP = pName.toLowerCase().trim();
                    if(visitedNames.has(lowerP)) continue;
                    visitedNames.add(lowerP);
                    
                    const realNode = state.data.find(n => n.food_name.toLowerCase().trim() === lowerP);
                    if(realNode) familyNodes.push(realNode);
                    
                    if(childrenMap[lowerP]) {
                        childrenMap[lowerP].forEach(child => {
                            familyNodes.push(child);
                            queue.push(child.food_name);
                        });
                    }
                }

                // 4. Render
                const uniqueNodes = Array.from(new Map(familyNodes.map(item => [item.id, item])).values());
                if(!uniqueNodes.find(n => n.id === d.id)) uniqueNodes.push(d); 
                
                let hasConnections = false;

                uniqueNodes.forEach(node => {
                    // RULES IMPLEMENTED: Check for food_name AND origin_food_name existence using isValidStr helper
                    if(node.origin_lat && node.origin_lng && node.lat && node.lng && isValidStr(node.origin_food_name) && isValidStr(node.food_name)) {
                        L.polyline([[node.origin_lat, node.origin_lng], [node.lat, node.lng]], { 
                            color: '#d4af37', 
                            weight: 2, 
                            dashArray: '6, 6', // Use dash array for styling
                            opacity: 0.8
                        }).addTo(map);
                        
                        L.circleMarker([node.origin_lat, node.origin_lng], { 
                            color: '#d4af37', 
                            fillColor: '#fff', 
                            fillOpacity: 1, 
                            radius: 3, 
                            weight: 1 
                        }).addTo(map);
                        
                        bounds.extend([node.origin_lat, node.origin_lng]);
                        hasConnections = true;
                    }
                    
                    const isCurrent = node.id === d.id;
                    L.circleMarker([node.lat, node.lng], { 
                        color: isCurrent ? '#ff1b2d' : '#1a1a2e', 
                        fillColor: isCurrent ? '#ff1b2d' : '#f3f4f6', 
                        fillOpacity: 1, 
                        radius: isCurrent ? 6 : 4, 
                        weight: isCurrent ? 0 : 2 
                    }).addTo(map);
                    
                    bounds.extend([node.lat, node.lng]);
                });

                if(hasConnections || uniqueNodes.length > 1) { 
                    if(bounds.isValid()) map.fitBounds(bounds, {padding:[50,50], animate: false}); 
                } else { 
                    map.setView([d.lat, d.lng], 4); 
                }
            }
            await new Promise(r => setTimeout(r, 1200)); 
            const canvas = await html2canvas(ghost, { useCORS: true, allowTaint: true, logging: false, scale: 2 });
            map.remove(); 
            return canvas.toDataURL('image/png');
        };

        function robustParse(val) {
            if (!val) return null;
            let str = String(val).trim();
            if ((str.match(/\./g) || []).length > 1) str = str.replace(/\./g, ''); 
            else if (str.includes(',') && str.includes('.')) str = str.replace(/\./g, '').replace(',', '.'); 
            else if (str.includes(',')) str = str.replace(',', '.'); 
            let n = parseFloat(str);
            return isNaN(n) ? null : (Math.abs(n) > 180 ? n/10 : n);
        }

        function transformData(item) {
             const get = (k) => item[Object.keys(item).find(x=>x.toLowerCase().includes(k))];
             const parseN = robustParse;
             return {
                id: get('id'), food_name: get('food_name')||get('name'), country: get('country'),
                lat: parseN(get('lat')), lng: parseN(get('lng')),
                origin_food_name: get('origin_food_name')||get('origin_name'), 
                origin_country: get('origin_country'),
                origin_lat: parseN(get('origin_lat')), origin_lng: parseN(get('origin_lng')),
                connection_type: get('connection_type')||get('type'), 
                youtube_url: get('youtube_url'), image_url: get('image_url'), 
                description: get('description'), geometry_json: get('geometry_json'),
                unesco_status: get('unesco_status'), research_links: get('research_links')
            };
        }

        window.ui = {
            openModal: (id) => {
                const el = document.getElementById(id);
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('modal-active'), 10);
            },
            closeModal: (id) => {
                const el = document.getElementById(id);
                el.classList.remove('modal-active');
                setTimeout(() => el.classList.add('hidden'), 300);
            },
            toggleSearch: () => {
                const el = document.getElementById('search-overlay');
                el.classList.toggle('hidden');
                if(!el.classList.contains('hidden')) document.getElementById('global-search').focus();
            },
            showLoader: (show) => {
                document.getElementById('crud-loader').classList.toggle('hidden', !show);
            }
        };

        // --- DIPERBAIKI: FAMILY TREE LOGIC ---
        window.detailMaps = {
            geo: null, conn: null,
            init: (d) => {
                if(window.detailMaps.geo) { window.detailMaps.geo.remove(); window.detailMaps.geo = null; }
                if(window.detailMaps.conn) { window.detailMaps.conn.remove(); window.detailMaps.conn = null; }
                setTimeout(() => {
                    // Peta Distribusi Area
                    if(document.getElementById('detail-geo-map')) {
                        const map1 = L.map('detail-geo-map', { zoomControl: false, attributionControl: false, dragging: false, scrollWheelZoom: false }).setView([d.lat, d.lng], 5);
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                            noWrap: true,
                            bounds: [[-90, -180], [90, 180]],
                            maxBounds: [[-90, -180], [90, 180]],
                            maxBoundsViscosity: 1.0
                        }).addTo(map1);
                        if(d.geometry_json) {
                            try {
                                const pts = JSON.parse(d.geometry_json);
                                L.polygon(pts, {color:'#ff1b2d', fillOpacity:0.2}).addTo(map1);
                                map1.fitBounds(pts, {padding:[20,20]});
                            } catch(e){}
                        }
                        window.detailMaps.geo = map1;
                    }

                    // Peta Foodways Connection (Family Tree)
                    if(document.getElementById('detail-conn-map')) {
                        const map2 = L.map('detail-conn-map', { zoomControl: false, attributionControl: false, dragging: true, scrollWheelZoom: false }); 
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                            noWrap: true,
                            bounds: [[-90, -180], [90, 180]],
                            maxBounds: [[-90, -180], [90, 180]],
                            maxBoundsViscosity: 1.0
                        }).addTo(map2);
                        
                        // 1. Persiapan Data Keluarga
                        const childrenMap = {};
                        state.data.forEach(item => {
                            if(isValidStr(item.origin_food_name)) {
                                const pName = item.origin_food_name.toLowerCase().trim();
                                if(!childrenMap[pName]) childrenMap[pName] = [];
                                childrenMap[pName].push(item);
                            }
                        });

                        // 2. Cari Leluhur Paling Atas (Root)
                        let rootName = d.food_name;
                        let curr = d;
                        const pathUp = new Set([d.id]);
                        
                        while(curr && isValidStr(curr.origin_food_name)) {
                            const parentName = curr.origin_food_name;
                            const parentNode = state.data.find(n => n.food_name.toLowerCase().trim() === parentName.toLowerCase().trim());
                            rootName = parentName; 
                            if(parentNode) {
                                if(pathUp.has(parentNode.id)) break; 
                                pathUp.add(parentNode.id);
                                curr = parentNode;
                            } else {
                                break; 
                            }
                        }

                        // 3. Telusuri ke Bawah (BFS) untuk dapatkan semua saudara/cucu
                        const familyNodes = [];
                        const queue = [rootName];
                        const visitedNames = new Set();
                        
                        while(queue.length > 0) {
                            const pName = queue.shift();
                            const lowerP = pName.toLowerCase().trim();
                            if(visitedNames.has(lowerP)) continue;
                            visitedNames.add(lowerP);
                            
                            // Tambahkan node itu sendiri jika ada di DB
                            const realNode = state.data.find(n => n.food_name.toLowerCase().trim() === lowerP);
                            if(realNode) familyNodes.push(realNode);
                            
                            // Tambahkan anak-anaknya ke antrian
                            if(childrenMap[lowerP]) {
                                childrenMap[lowerP].forEach(child => {
                                    familyNodes.push(child);
                                    queue.push(child.food_name);
                                });
                            }
                        }

                        // 4. Render ke Peta
                        const uniqueNodes = Array.from(new Map(familyNodes.map(item => [item.id, item])).values());
                        if(!uniqueNodes.find(n => n.id === d.id)) uniqueNodes.push(d); 
                        
                        const bounds = L.latLngBounds();
                        let hasConnections = false;

                        uniqueNodes.forEach(node => {
                            // RULES IMPLEMENTED: Validasi ketat nama dan asal menggunakan helper isValidStr
                            if(node.origin_lat && node.origin_lng && node.lat && node.lng && isValidStr(node.origin_food_name) && isValidStr(node.food_name)) {
                                L.polyline([[node.origin_lat, node.origin_lng], [node.lat, node.lng]], { 
                                    color: '#d4af37', 
                                    weight: 2, 
                                    dashArray: '6, 6',
                                    opacity: 0.6 
                                }).addTo(map2);
                                
                                // Titik Asal (Kecil Emas)
                                L.circleMarker([node.origin_lat, node.origin_lng], { 
                                    color: '#d4af37', 
                                    fillColor: '#fff', 
                                    fillOpacity: 1, 
                                    radius: 3, 
                                    weight: 1 
                                }).addTo(map2);
                                
                                bounds.extend([node.origin_lat, node.origin_lng]);
                                hasConnections = true;
                            }
                            
                            // Marker Node (Merah jika aktif, Biru gelap jika saudara)
                            const isCurrent = node.id === d.id;
                            const m = L.circleMarker([node.lat, node.lng], { 
                                color: isCurrent ? '#ff1b2d' : '#1a1a2e', 
                                fillColor: isCurrent ? '#ff1b2d' : '#f3f4f6', 
                                fillOpacity: 1, 
                                radius: isCurrent ? 6 : 4, 
                                weight: isCurrent ? 0 : 2 
                            }).addTo(map2);
                            
                            if(isCurrent) {
                                m.bindTooltip(node.food_name, { permanent: true, direction: 'top', className: 'custom-tooltip' });
                            } else {
                                m.on('click', () => { 
                                    window.ui.closeModal('detail-modal'); 
                                    setTimeout(() => window.dashboard.showDetail(node), 300); 
                                });
                            }
                            bounds.extend([node.lat, node.lng]);
                        });

                        if(hasConnections || uniqueNodes.length > 1) { 
                            if(bounds.isValid()) map2.fitBounds(bounds, {padding:[40,40]}); 
                        } else { 
                            map2.setView([d.lat, d.lng], 4); 
                        }
                        
                        window.detailMaps.conn = map2;
                    }
                }, 500); 
            }
        };

        window.mapLogic = {
            map: null, layers: [],
            init: () => {
                window.mapLogic.map = L.map('map-container', { zoomControl: false, attributionControl: false }).setView([20, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    noWrap: true,
                    bounds: [[-90, -180], [90, 180]],
                    maxBounds: [[-90, -180], [90, 180]],
                    maxBoundsViscosity: 1.0
                }).addTo(window.mapLogic.map);
            },
            render: () => {
                window.mapLogic.layers.forEach(l => window.mapLogic.map.removeLayer(l));
                window.mapLogic.layers = [];
                const filtered = state.filter ? state.data.filter(d => d.food_name.toLowerCase().includes(state.filter.toLowerCase()) || d.country.toLowerCase().includes(state.filter.toLowerCase())) : state.data;
                filtered.forEach(d => {
                    // RULES: Must have destination coordinates
                    if(d.lat == null || d.lng == null) return;

                    // RULES: Check for VALID origin data (coords + name) using STRICT helper
                    // If valid, DRAW LINE and DRAW ORIGIN DOT (Fix for "Tak Bernodes")
                    // IMPORTANT: Also check for valid origin country to be robust
                    if(d.origin_lat != null && d.origin_lng != null && isValidStr(d.origin_food_name) && isValidStr(d.food_name) && isValidStr(d.origin_country)) {
                        
                        // 1. Draw The Line
                        const line = L.polyline([[d.origin_lat, d.origin_lng], [d.lat, d.lng]], { 
                            color: '#d4af37', 
                            weight: 1.5, 
                            opacity: 0.3, 
                            dashArray: '4, 6' 
                        }).addTo(window.mapLogic.map);
                        window.mapLogic.layers.push(line);

                        // 2. Draw The Origin Node (The "Ghost" Fix)
                        const originNode = L.circleMarker([d.origin_lat, d.origin_lng], {
                            color: '#d4af37',      // Gold border
                            fillColor: '#fff',     // White fill
                            fillOpacity: 1,
                            radius: 3,             // Small radius
                            weight: 1
                        }).addTo(window.mapLogic.map);
                        
                        // Optional: Tooltip for origin
                        originNode.bindTooltip(`Origin: ${d.origin_food_name}`, { direction: 'top', className: 'custom-tooltip' });
                        window.mapLogic.layers.push(originNode);
                    }

                    // Destination Node (Main Red Dot) - Only if food_name is valid
                    if (isValidStr(d.food_name)) {
                        const m = L.circleMarker([d.lat, d.lng], { 
                            color: '#fff', 
                            fillColor: '#ff1b2d', 
                            fillOpacity: 1, 
                            radius: 6, 
                            weight: 2 
                        }).addTo(window.mapLogic.map);
                        m.on('click', () => { window.dashboard.showDetail(d); });
                        window.mapLogic.layers.push(m);
                    }
                });
            },
            resetZoom: () => { window.mapLogic.map.setView([20,0], 2); },
            enablePicker: (cb) => {
                document.getElementById('picker-ui').classList.remove('hidden');
                const handler = (e) => { cb(e.latlng.lat, e.latlng.lng); window.mapLogic.map.off('click', handler); document.getElementById('picker-ui').classList.add('hidden'); window.ui.openModal('input-modal'); };
                window.mapLogic.map.on('click', handler); window.mapLogic.pickerCancel = handler;
            },
            cancelPicker: () => { if(window.mapLogic.map && window.mapLogic.pickerCancel) { window.mapLogic.map.off('click', window.mapLogic.pickerCancel); document.getElementById('picker-ui').classList.add('hidden'); window.ui.openModal('input-modal'); } }
        };

        window.dashboard = {
            renderKPI: () => {
                document.getElementById('kpi-total').innerText = state.data.length;
                document.getElementById('kpi-countries').innerText = new Set(state.data.map(d=>d.country)).size;
            },
            renderAnalytics: () => {
                const ctx = document.getElementById('chart-type').getContext('2d');
                if (state.charts.types) state.charts.types.destroy();
                const counts = { Trade: 0, Migration: 0, Colonialism: 0 };
                state.data.forEach(d => { const type = d.connection_type ? d.connection_type.trim() : 'Trade'; if (counts[type] !== undefined) counts[type]++; else counts['Trade']++; });
                state.charts.types = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['Trade', 'Migration', 'Colonialism'], datasets: [{ data: [counts.Trade, counts.Migration, counts.Colonialism], backgroundColor: ['#d4af37', '#ff1b2d', '#1a1a2e'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right' } } }
                });
            },
            renderFeed: () => {
                const container = document.getElementById('card-feed');
                if(state.pagination.page === 1) container.innerHTML = '';
                const filtered = state.filter ? state.data.filter(d => d.food_name.toLowerCase().includes(state.filter.toLowerCase()) || d.country.toLowerCase().includes(state.filter.toLowerCase())) : state.data;
                const start = (state.pagination.page - 1) * state.pagination.limit;
                const end = start + state.pagination.limit;
                filtered.slice().reverse().slice(start, end).forEach(d => {
                    let img = d.image_url ? d.image_url.split(',')[0] : null;
                    const card = document.createElement('div');
                    card.className = 'mobile-card p-4 flex items-center gap-4 active:bg-gray-50';
                    card.onclick = () => window.dashboard.showDetail(d);
                    card.innerHTML = `<div class="w-14 h-14 rounded-2xl bg-gray-100 flex-shrink-0 overflow-hidden shadow-sm relative">${img ? `<img src="${img}" class="w-full h-full object-cover" onerror="handleImageError(this)">` : `<div class="w-full h-full flex items-center justify-center text-xl text-gray-300"><i class="fas fa-utensils"></i></div>`}</div><div class="flex-1 min-w-0"><h4 class="font-bold text-gray-800 text-sm truncate mb-1">${d.food_name}</h4><div class="flex items-center gap-2"><span class="text-[10px] text-gray-500 font-medium flex items-center bg-gray-50 px-2 py-0.5 rounded border border-gray-100"><i class="fas fa-map-marker-alt text-opera-red mr-1.5"></i> ${d.country}</span></div></div>`;
                    container.appendChild(card);
                });
                document.getElementById('btn-load-more').style.display = end >= filtered.length ? 'none' : 'inline-block';
            },
            loadMore: () => { state.pagination.page++; window.dashboard.renderFeed(); },
            
            // --- DIPERBAIKI: Mengembalikan Tampilan Detail yang Lengkap ---
            showDetail: (d) => {
                state.currentDetail = d;
                window.ui.openModal('detail-modal');
                document.getElementById('dt-header-title').innerText = d.food_name;
                const btnEdit = document.getElementById('btn-edit-entry');
                if(state.role === 'admin') btnEdit.classList.remove('hidden'); else btnEdit.classList.add('hidden');
                
                const container = document.getElementById('detail-container');
                
                // 1. Image Carousel
                let imagesHtml = ''; 
                if(d.image_url) { 
                    const urls = d.image_url.split(','); 
                    imagesHtml = `<div class="flex overflow-x-auto gap-3 p-4 snap-x no-scrollbar">${urls.map(u => `<img src="${u.trim()}" class="snap-center w-72 h-56 object-cover rounded-2xl border border-gray-100 shadow-md" onerror="this.style.display='none'">`).join('')}</div>`; 
                }
                
                // 2. Video Carousel
                const videoHtml = extractYoutubeCarousel(d.youtube_url);

                // 3. Render HTML
                container.innerHTML = `
                    ${imagesHtml}
                    <div class="px-5 pb-8">
                        <!-- Title & UNESCO -->
                        <div class="flex justify-between items-start mb-2">
                            <h1 class="text-3xl font-black text-opera-midnight leading-tight tracking-tight flex-1">${d.food_name}</h1>
                            ${d.unesco_status ? `<div class="w-8 h-8 rounded-full bg-green-50 flex items-center justify-center border border-green-200" title="UNESCO"><i class="fas fa-landmark text-green-600 text-xs"></i></div>` : ''}
                        </div>
                        
                        <!-- Badges -->
                        <div class="flex items-center gap-2 mb-8">
                            <span class="px-3 py-1 rounded-md bg-gray-100 text-gray-600 text-[10px] font-bold uppercase tracking-wider">${d.country}</span>
                            ${d.connection_type ? `<span class="px-3 py-1 rounded-md ${d.connection_type==='Trade'?'bg-yellow-50 text-yellow-700':d.connection_type==='Migration'?'bg-red-50 text-red-700':'bg-blue-50 text-blue-800'} text-[10px] font-bold uppercase tracking-wider">${d.connection_type}</span>` : ''}
                        </div>
                        
                        <!-- Evolutionary Path (Tree) -->
                        ${d.origin_food_name ? `
                        <div class="bg-gray-50 rounded-2xl p-5 mb-8 border border-gray-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-opera-gold/5 rounded-bl-full"></div>
                            <div class="text-[10px] text-gray-400 uppercase font-black tracking-widest mb-4 text-center">Evolutionary Path</div>
                            <div class="flex flex-col items-center gap-1 relative z-10">
                                <div class="text-center">
                                    <div class="font-bold text-gray-600 text-sm">${d.origin_food_name}</div>
                                    <div class="text-[10px] text-gray-400 font-medium tracking-wide">${d.origin_country}</div>
                                </div>
                                <div class="h-6 w-0.5 bg-gray-300 my-1"></div>
                                <div class="w-6 h-6 rounded-full bg-white border border-gray-200 flex items-center justify-center z-10 shadow-sm"><i class="fas fa-arrow-down text-[10px] text-gray-400"></i></div>
                                <div class="h-6 w-0.5 bg-gray-300 my-1"></div>
                                <div class="text-center">
                                    <div class="font-black text-opera-red text-xl">${d.food_name}</div>
                                    <div class="text-[10px] text-gray-500 font-medium tracking-wide">${d.country}</div>
                                </div>
                            </div>
                        </div>` : ''}
                        
                        <!-- Narrative -->
                        <div class="prose prose-sm text-gray-600 mb-8 leading-relaxed">
                            <h4 class="font-bold text-opera-midnight text-xs uppercase tracking-wider mb-3 border-b border-gray-100 pb-2">Historical Narrative</h4>
                            <p class="whitespace-pre-line text-sm">${d.description || 'No description provided.'}</p>
                        </div>
                    </div>
                    
                    ${videoHtml}
                    
                    <div class="px-5">
                        <div class="mb-6">
                            <h4 class="font-bold text-opera-midnight text-xs uppercase tracking-wider mb-3">Distribution</h4>
                            ${d.geometry_json ? `<div id="detail-geo-map" class="h-48 w-full bg-gray-100 rounded-2xl border border-gray-200 overflow-hidden shadow-inner"></div>` : '<div class="text-xs text-gray-400 italic bg-gray-50 p-4 rounded-xl text-center">No distribution data available.</div>'}
                        </div>
                        
                        <div class="mb-8">
                            <h4 class="font-bold text-opera-midnight text-xs uppercase tracking-wider mb-3">Foodways Connection</h4>
                            <div id="detail-conn-map" class="h-48 w-full bg-gray-100 rounded-2xl border border-gray-200 overflow-hidden shadow-inner"></div>
                        </div>

                        <!-- Sources -->
                        ${d.research_links ? `
                        <div class="bg-blue-50/50 p-5 rounded-2xl border border-blue-50 mb-8">
                            <h4 class="font-bold text-blue-900 text-[10px] uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-book"></i> Sources</h4>
                            <div class="flex flex-col gap-3 text-xs text-blue-700">
                                ${d.research_links.split(',').map(l => `<a href="${l}" target="_blank" class="flex items-center gap-2 truncate hover:underline"><i class="fas fa-external-link-alt text-[10px] opacity-50"></i> <span class="truncate">${l}</span></a>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
                
                window.detailMaps.init(d);
            }
        };

        window.app = {
            init: () => {
                Papa.parse(CSV_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => { if(res.data.length) { state.data = res.data.map(transformData).filter(x => x.lat && x.lng); document.getElementById('loading-indicator').innerHTML = '<i class="fas fa-check text-green-400"></i> <span class="text-xs text-gray-300 ml-1">Synced</span>'; document.getElementById('btn-enter').classList.remove('hidden'); } }
                });
            },
            enterApp: () => { document.getElementById('landing-page').classList.add('opacity-0'); setTimeout(() => { document.getElementById('landing-page').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); window.dashboard.renderKPI(); window.dashboard.renderFeed(); window.mapLogic.init(); window.mapLogic.render(); }, 500); },
            switchTab: (tab, el) => { 
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); 
                document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-map').classList.add('hidden'); document.getElementById('view-profile').classList.add('hidden'); 
                document.getElementById('view-'+tab).classList.remove('hidden'); 
                if(tab === 'map') { setTimeout(() => window.mapLogic.map.invalidateSize(), 100); }
                if(tab === 'profile') { setTimeout(() => window.dashboard.renderAnalytics(), 100); }
            },
            handleGlobalSearch: (val) => { state.filter = val; state.pagination.page = 1; window.dashboard.renderFeed(); window.mapLogic.render(); },
            initiateAddEntry: () => { state.editId = null; document.querySelectorAll('#input-modal input, #input-modal textarea').forEach(e => e.value = ''); document.getElementById('input-title').innerText = 'New Entry'; document.getElementById('btn-delete').classList.add('hidden'); document.getElementById('geo-status-text').innerText='Area not set'; window.ui.openModal('input-modal'); },
            openInputModal: (mode) => { if(mode === 'edit' && state.currentDetail) { const d = state.currentDetail; state.editId = d.id; document.getElementById('inp-id').value = d.id; document.getElementById('inp-name').value = d.food_name; document.getElementById('inp-country').value = d.country; document.getElementById('inp-lat').value = d.lat; document.getElementById('inp-lng').value = d.lng; document.getElementById('inp-desc').value = d.description; document.getElementById('inp-origin-name').value = d.origin_food_name || ''; document.getElementById('inp-origin-country').value = d.origin_country || ''; document.getElementById('inp-origin-lat').value = d.origin_lat || ''; document.getElementById('inp-origin-lng').value = d.origin_lng || ''; document.getElementById('inp-conn-type').value = d.connection_type || 'Trade'; document.getElementById('inp-image').value = d.image_url || ''; document.getElementById('inp-youtube').value = d.youtube_url || ''; document.getElementById('inp-unesco').value = d.unesco_status || ''; document.getElementById('inp-research').value = d.research_links || ''; document.getElementById('inp-geometry').value = d.geometry_json || ''; document.getElementById('geo-status-text').innerText = d.geometry_json ? 'Area defined' : 'Area not set'; document.getElementById('input-title').innerText = 'Edit Entry'; document.getElementById('btn-delete').classList.remove('hidden'); window.ui.closeModal('detail-modal'); window.ui.openModal('input-modal'); } },
            pickLocation: (target) => { state.pickerTarget = target; window.ui.closeModal('input-modal'); document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-profile').classList.add('hidden'); document.getElementById('view-map').classList.remove('hidden'); window.mapLogic.enablePicker((lat, lng) => { if(state.pickerTarget === 'main') { document.getElementById('inp-lat').value = lat.toFixed(5); document.getElementById('inp-lng').value = lng.toFixed(5); } else { document.getElementById('inp-origin-lat').value = lat.toFixed(5); document.getElementById('inp-origin-lng').value = lng.toFixed(5); } }); },
            cancelPicker: () => { if(window.mapLogic.map && window.mapLogic.pickerCancel) { window.mapLogic.map.off('click', window.mapLogic.pickerCancel); document.getElementById('picker-ui').classList.add('hidden'); window.ui.openModal('input-modal'); } },
            login: () => { const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value; const btn = document.getElementById('btn-login'); btn.innerText = 'Verifying...'; const form = new URLSearchParams(); form.append('action', 'login'); form.append('username', u); form.append('password', p); fetch(GAS_URL, { method: 'POST', body: form }).then(r=>r.json()).then(d => { if(d.status === 'success') { state.role = 'admin'; document.getElementById('profile-role').innerText = 'Admin Access'; document.getElementById('btn-login-profile').classList.add('hidden'); document.getElementById('btn-logout-profile').classList.remove('hidden'); document.getElementById('header-add-btn').classList.remove('hidden'); window.ui.closeModal('login-modal'); } else { alert('Invalid Credentials'); } btn.innerText = 'Login'; }).catch(e => { alert('Network Error'); btn.innerText = 'Login'; }); },
            logout: () => { state.role = 'guest'; document.getElementById('profile-role').innerText = 'Guest User'; document.getElementById('btn-login-profile').classList.remove('hidden'); document.getElementById('btn-logout-profile').classList.add('hidden'); document.getElementById('header-add-btn').classList.add('hidden'); },
            
            // --- NEW ORIGIN SEARCH & AUTOFILL ---
            handleOriginSearch: (val) => {
                const container = document.getElementById('origin-suggestions');
                if (!val || val.length < 1) {
                    container.classList.add('hidden');
                    container.innerHTML = '';
                    return;
                }
                const matches = state.data.filter(d => 
                    d.food_name.toLowerCase().includes(val.toLowerCase()) && 
                    d.id !== state.editId 
                ).slice(0, 5);

                if (matches.length === 0) {
                    container.classList.add('hidden');
                    return;
                }

                container.innerHTML = matches.map(d => `
                    <div onclick="window.app.selectOrigin('${d.id}')" class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer flex justify-between items-center transition-colors">
                        <div>
                            <div class="font-bold text-sm text-opera-midnight">${d.food_name}</div>
                            <div class="text-[10px] text-gray-500 font-medium">${d.country}</div>
                        </div>
                        <div class="w-6 h-6 rounded-full bg-opera-red/10 flex items-center justify-center">
                            <i class="fas fa-link text-opera-red text-[10px]"></i>
                        </div>
                    </div>
                `).join('');
                container.classList.remove('hidden');
            },
            
            selectOrigin: (id) => {
                const d = state.data.find(x => x.id === id);
                if (d) {
                    document.getElementById('inp-origin-name').value = d.food_name;
                    document.getElementById('inp-origin-country').value = d.country;
                    document.getElementById('inp-origin-lat').value = d.lat;
                    document.getElementById('inp-origin-lng').value = d.lng;
                    
                    const container = document.getElementById('origin-suggestions');
                    container.classList.add('hidden');
                    container.innerHTML = '';
                }
            },

            // --- AUDITED SAVE FUNCTION ---
            saveData: () => { 
                try {
                    // Capture Data
                    const d = { 
                        id: state.editId || '', 
                        food_name: document.getElementById('inp-name').value, 
                        country: document.getElementById('inp-country').value, 
                        lat: document.getElementById('inp-lat').value, 
                        lng: document.getElementById('inp-lng').value, 
                        description: document.getElementById('inp-desc').value, 
                        origin_food_name: document.getElementById('inp-origin-name').value, 
                        origin_country: document.getElementById('inp-origin-country').value, 
                        origin_lat: document.getElementById('inp-origin-lat').value, 
                        origin_lng: document.getElementById('inp-origin-lng').value, 
                        connection_type: document.getElementById('inp-conn-type').value, 
                        image_url: document.getElementById('inp-image').value, 
                        youtube_url: document.getElementById('inp-youtube').value, 
                        unesco_status: document.getElementById('inp-unesco').value, 
                        research_links: document.getElementById('inp-research').value,
                        // ENSURE HEADER 'GEOMETRY_JSON' IS CAPTURED
                        geometry_json: document.getElementById('inp-geometry').value 
                    }; 

                    window.ui.showLoader(true); 
                    const action = state.editId ? 'update' : 'insert'; 
                    const form = new URLSearchParams(); 
                    form.append('action', action); 
                    form.append('data', JSON.stringify(d)); 
                    
                    if (action === 'update' && state.currentDetail) { 
                        form.append('original_data', JSON.stringify({ food_name: state.currentDetail.food_name, lat: state.currentDetail.lat, lng: state.currentDetail.lng })); 
                    } 
                    
                    fetch(GAS_URL, { method: 'POST', body: form })
                        .then(r => r.json())
                        .then(res => { 
                            window.ui.showLoader(false); 
                            if(res.status === 'success') { 
                                // UPDATE LOCAL STATE (Prevent Refresh)
                                if (action === 'insert') { 
                                    state.data.push({ ...d, id: 'temp-' + Date.now() }); 
                                } else { 
                                    const idx = state.data.findIndex(x => x.id === state.editId); 
                                    if (idx > -1) state.data[idx] = { ...state.data[idx], ...d }; 
                                } 
                                
                                // RENDER & CLOSE
                                window.dashboard.renderFeed(); 
                                window.mapLogic.render(); 
                                window.dashboard.renderKPI(); 
                                window.ui.closeModal('input-modal'); 
                                
                                // PREVENT KICK TO TITLE
                                document.getElementById('landing-page').classList.add('hidden');
                                document.getElementById('main-app').classList.remove('hidden');

                                if (action === 'update' && state.currentDetail && state.currentDetail.id === state.editId) { 
                                    const updated = state.data.find(x => x.id === state.editId); 
                                    if(updated) window.dashboard.showDetail(updated); 
                                } 
                            } else {
                                alert(res.message); 
                            }
                        })
                        .catch(err => {
                            window.ui.showLoader(false);
                            alert("Connection Error. Data not saved.");
                            console.error(err);
                        });
                } catch(e) {
                    window.ui.showLoader(false);
                    console.error("Critical Save Error", e);
                }
            },
            
            // --- AUDITED DELETE FUNCTION ---
            deleteData: () => { 
                if(!confirm('Delete this entry?')) return; 
                try {
                    window.ui.showLoader(true); 
                    const form = new URLSearchParams(); 
                    form.append('action', 'delete'); 
                    form.append('id', state.editId); 
                    form.append('data', JSON.stringify({ food_name: state.currentDetail.food_name, lat: state.currentDetail.lat, lng: state.currentDetail.lng })); 
                    
                    fetch(GAS_URL, { method: 'POST', body: form })
                        .then(r => r.json())
                        .then(res => { 
                            window.ui.showLoader(false); 
                            if(res.status === 'success') { 
                                state.data = state.data.filter(x => x.id !== state.editId); 
                                window.dashboard.renderFeed(); 
                                window.mapLogic.render(); 
                                window.dashboard.renderKPI(); 
                                window.ui.closeModal('input-modal'); 
                                window.ui.closeModal('detail-modal'); 
                                
                                // PREVENT KICK TO TITLE
                                document.getElementById('landing-page').classList.add('hidden');
                                document.getElementById('main-app').classList.remove('hidden');
                            } else {
                                alert(res.message); 
                            }
                        })
                        .catch(err => {
                            window.ui.showLoader(false);
                            alert("Connection Error during delete.");
                        });
                } catch(e) {
                    window.ui.showLoader(false);
                    console.error("Critical Delete Error", e);
                }
            },
            exportToPDF: async () => { 
                const d = state.currentDetail; if(!d) return;
                const btn = document.querySelector('button[onclick="window.app.exportToPDF()"]');
                const oldContent = btn ? btn.innerHTML : '';
                if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; }
                try {
                    let geoMapImg = null, connMapImg = null;
                    if(d.geometry_json || (d.lat && d.lng)) { geoMapImg = await generateMapSnapshot(d, 'geo'); }
                    if(d.origin_lat || d.origin_food_name) { connMapImg = await generateMapSnapshot(d, 'conn'); }
                    const content = document.createElement('div');
                    content.style.width = '100%'; content.style.padding = '30px'; content.style.fontFamily = "'Helvetica', 'Arial', sans-serif"; content.style.color = '#1a1a2e'; content.style.background = '#fff';
                    content.innerHTML = `<div style="border-bottom: 4px solid #ff1b2d; padding-bottom: 20px; margin-bottom: 30px;"><h1 style="font-size: 32px; font-weight: 900; margin: 0; line-height: 1.2; color: #1a1a2e;">${d.food_name}</h1><div style="margin-top: 10px; font-size: 14px; font-weight: bold; color: #666;"><span style="color: #ff1b2d;">${d.country.toUpperCase()}</span>${d.unesco_status ? ` â€¢ <span style="color: #047857;">UNESCO RECOGNIZED</span>` : ''}</div></div>${d.image_url ? `<div style="margin-bottom: 30px; display: flex; gap: 10px; height: 200px; overflow: hidden;">${d.image_url.split(',').slice(0,3).map(u => `<img src="${u.trim()}" style="flex: 1; height: 100%; object-fit: cover; border-radius: 8px;" crossorigin="anonymous" onerror="this.style.display='none'">`).join('')}</div>` : ''}${d.origin_food_name ? `<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid #d4af37;"><h3 style="font-size: 12px; font-weight: bold; color: #999; text-transform: uppercase; margin: 0 0 10px 0;">Heritage Lineage</h3><div style="font-size: 16px; font-weight: bold;">${d.origin_food_name} <span style="font-weight: normal; font-size: 14px; color: #666;">(${d.origin_country})</span></div><div style="color: #d4af37; font-size: 20px; margin: 5px 0;">â†“ <span style="font-size: 12px; font-weight: bold; color: #d4af37; vertical-align: middle; text-transform: uppercase;">${d.connection_type}</span></div><div style="font-size: 16px; font-weight: bold; color: #ff1b2d;">${d.food_name}</div></div>` : ''}<div style="margin-bottom: 30px;"><h3 style="font-size: 14px; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">Historical Narrative</h3><p style="font-size: 12px; line-height: 1.8; text-align: justify;">${d.description || 'No description available.'}</p></div><div style="page-break-inside: avoid;">${geoMapImg ? `<div style="margin-bottom: 20px;"><h4 style="font-size: 12px; font-weight: bold; margin-bottom: 10px;">Geographic Distribution</h4><img src="${geoMapImg}" style="width: 100%; border-radius: 8px; border: 1px solid #eee;"></div>` : ''}${connMapImg ? `<div><h4 style="font-size: 12px; font-weight: bold; margin-bottom: 10px;">Cultural Connections</h4><img src="${connMapImg}" style="width: 100%; border-radius: 8px; border: 1px solid #eee;"></div>` : ''}</div><div style="margin-top: 40px; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #eee; padding-top: 20px;">Generated by Foodways Mobile â€¢ Shared Heritage Project</div>`;
                    await html2pdf().set({ margin: 15, filename: `${d.food_name}_Profile.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(content).save();
                } catch(e) { console.error(e); alert("PDF Generation Failed"); } finally { if(btn) { btn.disabled = false; btn.innerHTML = oldContent; } }
            }
        };

        window.addEventListener('load', () => {
            if (typeof Papa !== 'undefined') {
                if(window.app && typeof window.app.init === 'function') { window.app.init(); }
            }
        });
    </script>
</body>
</html>
